// import React, { useEffect, useState, useCallback } from 'react';
// import { useSelector, useDispatch } from 'react-redux';
// import StudioEditor from "@grapesjs/studio-sdk/react";
// import "@grapesjs/studio-sdk/style";
// import { useParams, useNavigate } from 'react-router-dom';
// import { FaSync, FaDownload, FaArrowLeft, FaMagic, FaFileAlt, FaSave, FaFileExport } from 'react-icons/fa';
// import axios from "axios";

// import { updateProjectData, setSelectedTemplateForStage, updateStageBasicInfo, saveFunnelToBackend, fetchFunnelBySlug, resetState } from '../../../../redux/funnel.jsx';
// import { templates } from './df_temp.jsx';
// import addLandingPageComponents from './function.jsx';
// import "./old.css";

// // GrapesJS Plugins
// import gjsPresetWebpage from "grapesjs-preset-webpage";
// import gjsForms from "grapesjs-plugin-forms";
// import gjsCountdown from "grapesjs-component-countdown";
// import gjsTabs from "grapesjs-tabs";
// import gjsCustomCode from "grapesjs-custom-code";
// import gjsTooltip from "grapesjs-tooltip";
// import gjsTyped from "grapesjs-typed";
// import gjsNavbar from "grapesjs-navbar";
// import gjsBlocksBasic from "grapesjs-blocks-basic";

// //** Redirect Page Selector Popup **//
// const RedirectPageSelector = ({ stages, currentStageId, onSelect, onClose }) => {
//     const [selectedPage, setSelectedPage] = useState('');

//     const handleSubmit = (e) => {
//         e.preventDefault();
//         if (!selectedPage) {
//             alert('Please select a redirect page');
//             return;
//         }
//         onSelect(selectedPage);
//         onClose();
//     };

//     return (
//         <div className="redirect-popup-content">
//             <h3>Select Redirect Page</h3>
//             <p>Choose where users should be redirected after form submission:</p>
            
//             <form onSubmit={handleSubmit}>
//                 <div className="form-group">
//                     <select 
//                         value={selectedPage} 
//                         onChange={(e) => setSelectedPage(e.target.value)}
//                         required
//                     >
//                         <option value="">-- Select a page --</option>
//                         {stages
//                             .filter(stage => stage.id !== currentStageId)
//                             .map(stage => (
//                                 <option key={stage.id} value={stage.slug || stage.id}>
//                                     {stage.name} ({stage.type})
//                                 </option>
//                             ))}
//                     </select>
//                 </div>
                
//                 <div className="popup-buttons">
//                     <button type="button" onClick={onClose} className="cancel-btn">
//                         Cancel
//                     </button>
//                     <button type="submit" className="submit-btn">
//                         Set Redirect
//                     </button>
//                 </div>
//             </form>
//         </div>
//     );
// };

// //** Template Selector Component **//
// const StageTemplateSelector = ({ stageType, selectedKey, onSelect }) => {
//     const templateSet = {
//         'welcome-page': templates.welcomeTemplates,
//         'vsl-page': templates.vslTemplates,
//         'thankyou-page': templates.thankyouTemplates,
//         'whatsapp-page': templates.whatsappTemplates,
//         'product-offer': templates.productOfferTemplates,
//         'custom-page': templates.miscTemplates,
//         'appointment-page': templates.appointmentTemplates,
//         'payment-page': templates.paymentTemplates,
//     }[stageType];

//     if (!templateSet || Object.keys(templateSet).length === 0) {
//         return (
//             <div className="no-templates-message">
//                 <p>No templates available for this stage type.</p>
//             </div>
//         );
//     }

//     return (
//         <div className="template-selector-container">
//             <h3 className="template-selector-title">Select a Template</h3>
//             <div className="template-grid">
//                 {Object.entries(templateSet).map(([key, template]) => (
//                     <div
//                         key={key}
//                         className={`template-card ${selectedKey === key ? 'selected' : ''}`}
//                         onClick={() => onSelect(key)}
//                     >
//                         <div className="template-thumbnail">
//                             <img
//                                 src={template.thumbnail}
//                                 alt={template.name}
//                                 onError={(e) => {
//                                     e.target.onerror = null;
//                                     e.target.src = 'https://placehold.co/400x300/ccc/ffffff?text=No+Image';
//                                 }}
//                             />
//                         </div>
//                         <div className="template-info">
//                             <h4>{template.name}</h4>
//                             <p>{template.description}</p>
//                         </div>
//                     </div>
//                 ))}
//             </div>
//         </div>
//     );
// };

// //** AI Generative Popup Component **//
// const AIGenerativePopup = ({ onClose, onSubmit, isLoading }) => {
//     const [description, setDescription] = useState('');

//     const handleSubmit = () => {
//         if (!description.trim()) {
//             alert('Please provide a description for the content you want to generate.');
//             return;
//         }
//         onSubmit({ description });
//     };

//     return (
//         <div className="ai-popup-content">
//             <h3>AI Content Generation</h3>
//             <p>Describe the changes you want to make to the content:</p>

//             <div className="description-section">
//                 <label>Describe what you want:</label>
//                 <textarea
//                     value={description}
//                     onChange={(e) => setDescription(e.target.value)}
//                     placeholder="e.g., 'Make the headline more exciting and shorten the paragraph about benefits.'"
//                     rows={4}
//                 />
//             </div>

//             <div className="ai-popup-buttons">
//                 <button onClick={onClose} className="ai-cancel-btn cancel" disabled={isLoading}>
//                     Cancel
//                 </button>
//                 <button
//                     onClick={handleSubmit}
//                     className="ai-submit-btn upload"
//                     disabled={isLoading || !description.trim()}
//                 >
//                     {isLoading ? 'Generating...' : 'Update Content'}
//                 </button>
//             </div>
//         </div>
//     );
// };

// //** Main Editor Component **//
// const PortfolioEdit = () => {
//     const dispatch = useDispatch();
//     const navigate = useNavigate();
//     const { slug, stageId } = useParams();

//     const { contentData, stages, apiStatus } = useSelector((state) => state.funnel);
//     const { user } = useSelector((state) => state.auth);
//     const API_BASE_URL = window.API_BASE_URL || 'http://localhost:5000';

//     const [editorInstance, setEditorInstance] = useState(null);
//     const [showTemplateSelector, setShowTemplateSelector] = useState(false);
//     const [showAIPopup, setShowAIPopup] = useState(false);
//     const [showRedirectPopup, setShowRedirectPopup] = useState(false);
//     const [isAILoading, setIsAILoading] = useState(false);
//     const [currentStage, setCurrentStage] = useState(null);
//     const [forceRefreshKey, setForceRefreshKey] = useState(0);
//     const [assets, setAssets] = useState([]);
//     const [selectedRedirectPage, setSelectedRedirectPage] = useState('');

//     useEffect(() => {
//         if (typeof window !== 'undefined') {
//             window.reduxStore = {
//                 getState: () => ({
//                     funnel: {
//                         stages: stages,
//                         contentData: contentData
//                     }
//                 })
//             };
//         }
        
//         return () => {
//             if (typeof window !== 'undefined') {
//                 delete window.reduxStore;
//             }
//         };
//     }, [stages, contentData]);

//     useEffect(() => {
//         if (slug) {
//             dispatch(fetchFunnelBySlug(slug));
//         }
//     }, [dispatch, slug]);

//     useEffect(() => {
//         if (stages && stageId) {
//             const stage = stages.find(s => s.id === stageId);
//             if (stage) {
//                 setCurrentStage(stage);
//                 const stageConfig = contentData.stagesConfig?.[stage.type] || 
//                                   contentData.customStagesConfig?.[stage.id];
//                 if (stageConfig?.redirectPage) {
//                     setSelectedRedirectPage(stageConfig.redirectPage);
//                 }
//             }
//         }
//     }, [stages, stageId, contentData]);

//     const uploadFiles = async files => {
//         const fd = new FormData();
//         files.forEach(f => fd.append('assets', f));
      
//         try {
//             const { data } = await axios.post(`${API_BASE_URL}/api/assets`, fd, {
//                 headers: {
//                     'Content-Type': 'multipart/form-data'
//                 }
//             });
//             return data.data.map(asset => ({
//                 ...asset,
//                 src: asset.src.startsWith('/') ? asset.src : `/${asset.src}`
//             }));
//         } catch (error) {
//             console.error('Upload error:', error);
//             throw error;
//         }
//     };

//     useEffect(() => {
//         const fetchInitialAssets = async () => {
//             try {
//                 const response = await fetch(`${API_BASE_URL}/api/assets?userId=${user?.name || 'guest'}`);
//                 if (!response.ok) {
//                     throw new Error(`Failed to fetch assets: ${response.statusText}`);
//                 }
//                 const result = await response.json();
//                 setAssets(result.data || []);
//             } catch (error) {
//                 console.error("Error fetching initial assets:", error);
//                 setAssets([]);
//             }
//         };
//         fetchInitialAssets();
//     }, []);

//     // Function to update direct forms with redirect URL
//     const updateDirectFormsRedirect = (editor, redirectSlug) => {
//         if (!editor || !redirectSlug) return;
        
//         setTimeout(() => {
//             const wrapper = editor.DomComponents.getWrapper();
//             const directContainers = wrapper.find('.bss-direct-form-container');
            
//             let updatedCount = 0;
//             directContainers.forEach(container => {
//                 const form = container.find('.bss-direct-form').at(0);
//                 if (form) {
//                     form.addAttributes({ 'data-redirect-page': redirectSlug });
                    
//                     const view = form.getView();
//                     if (view && view.el) {
//                         view.el.setAttribute('data-redirect-page', redirectSlug);
//                     }
                    
//                     updatedCount++;
//                     console.log('Updated direct form redirect to:', redirectSlug);
//                 }
//             });
            
//             console.log(`Updated ${updatedCount} direct forms with redirect: ${redirectSlug}`);
            
//             editor.trigger('change:canvas');
//             editor.runCommand('canvas:reload');
//         }, 100);
//     };

//     // Initialize form handlers globally
//     const initializeDirectFormHandlers = () => {
//         const initializeAllForms = () => {
//             const forms = document.querySelectorAll('.bss-direct-form:not([data-initialized])');
            
//             forms.forEach(form => {
//                 form.setAttribute('data-initialized', 'true');
                
//                 const container = form.closest('.bss-direct-form-container');
//                 const messageEl = container ? container.querySelector('.form-message') : null;
//                 const submitBtn = form.querySelector('.bss-submit-btn');
                
//                 const showMessage = (message, type) => {
//                     if (messageEl) {
//                         messageEl.style.display = 'block';
//                         messageEl.className = 'form-message ' + type;
//                         messageEl.textContent = message;
//                         messageEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
//                     } else {
//                         console.log(type.toUpperCase() + ': ' + message);
//                         alert(message);
//                     }
//                 };

//                 const hideMessage = () => {
//                     if (messageEl) {
//                         messageEl.style.display = 'none';
//                         messageEl.textContent = '';
//                     }
//                 };
                
//                 const inputs = form.querySelectorAll('input');
//                 inputs.forEach(input => {
//                     input.addEventListener('focus', hideMessage);
//                 });
                
//                 form.addEventListener('submit', async function(e) {
//                     e.preventDefault();
                    
//                     if (!submitBtn) return;
                    
//                     const originalText = submitBtn.innerHTML;
//                     submitBtn.innerHTML = '<span>Processing...</span>';
//                     submitBtn.disabled = true;
//                     hideMessage();
                    
//                     const redirectPage = this.getAttribute('data-redirect-page') || 
//                                        container.getAttribute('data-redirect-page');
                    
//                     try {
//                         const formData = {
//                             name: this.querySelector('input[name="name"]').value,
//                             email: this.querySelector('input[name="email"]').value,
//                             phone: this.querySelector('input[name="phone"]').value,
//                             timestamp: new Date().toISOString(),
//                             source: 'Direct Form',
//                             campaign: 'Website Lead'
//                         };
                        
//                         console.log('ðŸ“ FORM SUBMISSION:', formData);
                        
//                         await new Promise(resolve => setTimeout(resolve, 1500));
                        
//                         showMessage('ðŸŽ‰ Thank you! Your submission was successful!', 'success');
                        
//                         setTimeout(() => {
//                             if (redirectPage && redirectPage.trim() !== '') {
//                                 console.log('Redirecting to:', redirectPage);
                                
//                                 let redirectUrl;
//                                 if (redirectPage.startsWith('http')) {
//                                     redirectUrl = redirectPage;
//                                 } else if (redirectPage.startsWith('/')) {
//                                     redirectUrl = redirectPage;
//                                 } else {
//                                     const currentPath = window.location.pathname;
//                                     const pathParts = currentPath.split('/').filter(Boolean);
//                                     const funnelSlug = pathParts[0] || 'funnel';
//                                     redirectUrl = `/${funnelSlug}/${redirectPage}`;
//                                 }
                                
//                                 console.log('Final redirect URL:', redirectUrl);
//                                 setTimeout(() => {
//                                     window.location.href = redirectUrl;
//                                 }, 2000);
//                             }
//                         }, 1000);
                        
//                         setTimeout(() => {
//                             this.reset();
//                         }, 3000);
                        
//                     } catch (error) {
//                         console.error('Form submission error:', error);
//                         showMessage('Sorry, there was an error. Please try again.', 'error');
//                     } finally {
//                         setTimeout(() => {
//                             if (submitBtn) {
//                                 submitBtn.innerHTML = originalText;
//                                 submitBtn.disabled = false;
//                             }
//                         }, 1000);
//                     }
//                 });
//             });
//         };
        
//         if (document.readyState === 'loading') {
//             document.addEventListener('DOMContentLoaded', initializeAllForms);
//         } else {
//             initializeAllForms();
//         }
        
//         setTimeout(initializeAllForms, 1000);
//     };

//     const onEditorReady = useCallback((editor) => {
//         window.editor = editor;
//         setEditorInstance(editor);
//  const getPageElements = () => {
//         const elements = [{ id: '', name: '-- Select element --' }];
//         const currentPage = editor.Pages.getSelected();
        
//         if (currentPage) {
//             const walkComponents = (component) => {
//                 if (!component) return;
                
//                 const id = component.getId();
//                 if (id) {
//                     const tagName = component.get('tagName') || 'div';
//                     elements.push({
//                         id: `#${id}`,
//                         name: `${tagName}#${id}`
//                     });
//                 }
                
//                 component.components().forEach(walkComponents);
//             };
            
//             walkComponents(currentPage.getMainComponent());
//         }
        
//         return elements;
//     };

//     // Link component configuration
//     editor.DomComponents.addType('link', {
//         model: {
//             defaults: {
//                 traits: [
//                     {
//                         name: 'title',
//                         label: 'Title'
//                     },
//                     {
//                         name: 'target',
//                         type: 'select',
//                         label: 'Target',
//                         options: [
//                             { id: '', name: 'This window' },
//                             { id: '_blank', name: 'New window' }
//                         ]
//                     },
//                     // Manual URL input
//                     {
//                         type: 'text',
//                         label: 'URL',
//                         name: 'href',
//                         placeholder: 'Enter URL or use options below'
//                     },
//                     // Page selector dropdown
//                     {
//                         type: 'select',
//                         label: 'Link to Page',
//                         name: 'pageLink',
//                         options: [
//                             { id: '', name: '-- Select a page --' },
//                             ...stages
//                                 .filter(stage => stage.id !== stageId)
//                                 .map(stage => ({
//                                     id: stage.id,
//                                     name: `${stage.name} (${stage.type})`
//                                 }))
//                         ],
//                         changeProp: 1
//                     },
//                     // Element ID selector for anchors (now dynamic)
//                     {
//                         type: 'select',
//                         label: 'Link to Element',
//                         name: 'anchorLink',
//                         options: getPageElements(),
//                         changeProp: 1
//                     }
//                 ]
//             },
            
//             init() {
//                 this.on('change:pageLink', this.handlePageLink);
//                 this.on('change:anchorLink', this.handleAnchorLink);
//             },
            
//             handlePageLink() {
//                 const pageId = this.get('pageLink');
//                 if (pageId) {
//                     const newHref = `${pageId}`;
//                     this.addAttributes({ href: newHref });
//                     console.log('Page link set to:', newHref);
//                     // Clear anchor selection
//                     this.set('anchorLink', '');
//                 }
//             },
            
//             handleAnchorLink() {
//                 const anchorId = this.get('anchorLink');
//                 if (anchorId) {
//                     this.addAttributes({ href: anchorId });
//                     console.log('Anchor link set to:', anchorId);
//                     // Clear page selection
//                     this.set('pageLink', '');
//                 }
//             }
//         }
//     });

//     // Button component with link functionality (updated with dynamic element options)
//     editor.DomComponents.addType('button', {
//         extend: 'text',
//         isComponent: el => el.tagName === 'BUTTON',
//         model: {
//             defaults: {
//                 tagName: 'button',
//                 traits: [
//                     {
//                         type: 'text',
//                         label: 'Button Text',
//                         name: 'content',
//                         changeProp: 1
//                     },
//                     {
//                         type: 'select',
//                         label: 'Button Type',
//                         name: 'type',
//                         options: [
//                             { id: 'button', name: 'Button' },
//                             { id: 'submit', name: 'Submit' },
//                             { id: 'reset', name: 'Reset' }
//                         ]
//                     },
//                     {
//                         type: 'checkbox',
//                         label: 'Make it a Link',
//                         name: 'makeLink',
//                         changeProp: 1
//                     },
//                     {
//                         type: 'text',
//                         label: 'Link URL',
//                         name: 'linkUrl',
//                         placeholder: 'Enter URL',
//                         getVisibility() {
//                             return this.model.get('makeLink');
//                         }
//                     },
//                     {
//                         type: 'select',
//                         label: 'Link to Page',
//                         name: 'linkToPage',
//                         options: [
//                             { id: '', name: '-- Select a page --' },
//                             ...stages
//                                 .filter(stage => stage.id !== stageId)
//                                 .map(stage => ({
//                                     id: stage.id,
//                                     name: `${stage.name} (${stage.type})`
//                                 }))
//                         ],
//                         getVisibility() {
//                             return this.model.get('makeLink');
//                         }
//                     },
//                     {
//                         type: 'select',
//                         label: 'Link to Element',
//                         name: 'linkToElement',
//                         options: getPageElements(),
//                         getVisibility() {
//                             return this.model.get('makeLink');
//                         }
//                     },
//                     {
//                         type: 'checkbox',
//                         label: 'Open in new tab',
//                         name: 'newTab',
//                         getVisibility() {
//                             return this.model.get('makeLink');
//                         }
//                     }
//                 ]
//             },
            
//             init() {
//                 this.on('change:makeLink', this.handleMakeLink);
//                 this.on('change:linkUrl', this.handleLinkUrl);
//                 this.on('change:linkToPage', this.handleLinkToPage);
//                 this.on('change:linkToElement', this.handleLinkToElement);
//                 this.on('change:newTab', this.handleNewTab);
//                 this.on('change:content', this.handleContent);
//             },
            
//             // ... rest of the button component methods ...
//         }
//     });

//     // Refresh element options when page changes
//     editor.on('page', () => {
//         const linkType = editor.DomComponents.getType('link');
//         if (linkType) {
//             linkType.model.prototype.defaults.traits.find(
//                 t => t.name === 'anchorLink'
//             ).options = getPageElements();
//         }
        
//         const buttonType = editor.DomComponents.getType('button');
//         if (buttonType) {
//             buttonType.model.prototype.defaults.traits.find(
//                 t => t.name === 'linkToElement'
//             ).options = getPageElements();
//         }
//     });
    
//         // Add the direct form component
//         editor.BlockManager.add('direct-form', {
//             label: 'Direct Form',
//             category: 'Forms',
//             content: `
//             <div class="bss-direct-form-container" data-redirect-page="${selectedRedirectPage || ''}">
//                 <div class="bss-form-content">
//                     <div class="bss-form-header">
//                         <h3>Join Our Community</h3>
//                         <p>Get exclusive updates and offers</p>
//                     </div>
                    
//                     <form class="bss-direct-form" data-redirect-page="${selectedRedirectPage || ''}" data-redirect-set="true">
//                         <div class="form-group">
//                             <input type="text" name="name" placeholder="Your Name" required>
//                         </div>
//                         <div class="form-group">
//                             <input type="email" name="email" placeholder="Your Email" required>
//                         </div>
//                         <div class="form-group">
//                             <input type="tel" name="phone" placeholder="Phone Number (Optional)">
//                         </div>
//                         <button type="submit" class="bss-submit-btn">
//                             <i class="fas fa-paper-plane"></i> SEND
//                         </button>
//                     </form>
                    
//                     <div class="form-message" style="display:none; margin-top:15px;"></div>
                    
//                     <div class="bss-form-footer">
//                         <p>We respect your privacy. Unsubscribe at any time.</p>
//                     </div>
//                 </div>
                
//                 <style>
//                     .bss-direct-form-container { 
//                         font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
//                         max-width: 500px;
//                         margin: 20px auto;
//                         padding: 0;
//                     }
//                     .bss-form-content {
//                         background-color: #fff;
//                         padding: 30px;
//                         border-radius: 12px;
//                         box-shadow: 0 8px 25px rgba(0,0,0,0.15);
//                         border: 1px solid #e1e8ed;
//                     }
//                     .bss-form-header {
//                         text-align: center;
//                         margin-bottom: 25px;
//                     }
//                     .bss-form-header h3 {
//                         color: #2c3e50;
//                         margin: 0 0 10px 0;
//                         font-size: 24px;
//                         font-weight: 600;
//                     }
//                     .bss-form-header p {
//                         color: #7f8c8d;
//                         font-size: 16px;
//                         margin: 0;
//                         line-height: 1.5;
//                     }
//                     .form-group { 
//                         margin-bottom: 20px; 
//                     }
//                     .form-group input {
//                         width: 100%;
//                         padding: 15px;
//                         border: 2px solid #e1e8ed;
//                         border-radius: 8px;
//                         font-size: 16px;
//                         box-sizing: border-box;
//                         transition: all 0.3s ease;
//                         background-color: #f8f9fa;
//                     }
//                     .form-group input:focus {
//                         outline: none;
//                         border-color: #4CAF50;
//                         background-color: #fff;
//                         box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
//                     }
//                     .form-group input:hover {
//                         border-color: #bdc3c7;
//                         background-color: #fff;
//                     }
//                     .bss-submit-btn {
//                         width: 100%;
//                         padding: 15px;
//                         background: linear-gradient(135deg, #4CAF50, #45a049);
//                         color: white;
//                         border: none;
//                         border-radius: 8px;
//                         font-size: 18px;
//                         font-weight: 600;
//                         cursor: pointer;
//                         transition: all 0.3s ease;
//                         display: flex;
//                         align-items: center;
//                         justify-content: center;
//                         gap: 10px;
//                         text-transform: uppercase;
//                         letter-spacing: 0.5px;
//                     }
//                     .bss-submit-btn:hover { 
//                         background: linear-gradient(135deg, #45a049, #4CAF50);
//                         transform: translateY(-2px);
//                         box-shadow: 0 8px 20px rgba(76, 175, 80, 0.3);
//                     }
//                     .bss-submit-btn:active {
//                         transform: translateY(0);
//                     }
//                     .bss-submit-btn:disabled {
//                         background: #bdc3c7;
//                         cursor: not-allowed;
//                         transform: none;
//                         box-shadow: none;
//                     }
//                     .form-message {
//                         padding: 15px;
//                         border-radius: 8px;
//                         text-align: center;
//                         font-size: 16px;
//                         font-weight: 500;
//                     }
//                     .form-message.success {
//                         background-color: #d4edda;
//                         color: #155724;
//                         border: 1px solid #c3e6cb;
//                     }
//                     .form-message.error {
//                         background-color: #f8d7da;
//                         color: #721c24;
//                         border: 1px solid #f5c6cb;
//                     }
//                     .bss-form-footer {
//                         margin-top: 25px;
//                         text-align: center;
//                         padding-top: 20px;
//                         border-top: 1px solid #e1e8ed;
//                     }
//                     .bss-form-footer p {
//                         font-size: 14px;
//                         color: #95a5a6;
//                         margin: 0;
//                         line-height: 1.4;
//                     }
                    
//                     @media (max-width: 600px) {
//                         .bss-direct-form-container {
//                             margin: 10px;
//                             max-width: none;
//                         }
//                         .bss-form-content {
//                             padding: 20px;
//                         }
//                         .bss-form-header h3 {
//                             font-size: 20px;
//                         }
//                         .bss-form-header p {
//                             font-size: 14px;
//                         }
//                         .form-group input {
//                             padding: 12px;
//                             font-size: 16px;
//                         }
//                         .bss-submit-btn {
//                             padding: 12px;
//                             font-size: 16px;
//                         }
//                     }
                    
//                     @keyframes spin {
//                         0% { transform: rotate(0deg); }
//                         100% { transform: rotate(360deg); }
//                     }
//                     .fa-spin {
//                         animation: spin 1s linear infinite;
//                     }
//                 </style>
//             `,
//             attributes: { class: 'bss-direct-form-element' },
//             media: `<svg viewBox="0 0 24 24"><path fill="currentColor" d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg>`,
//         });

//         addLandingPageComponents(editor, user?.name || 'guest');
        
//         // Initialize form handlers
//         initializeDirectFormHandlers();
        
//         const pagesEl = document.querySelector("#pages");
//         if (pagesEl) {
//             editor.Pages.__appendTo({ el: pagesEl });
//         }
        
//         setTimeout(() => {
//             const pageToSelect = editor.Pages.get(stageId);
//             if (pageToSelect) {
//                 editor.Pages.select(pageToSelect);
//                 editor.runCommand('canvas:reload');
//             } else if (editor.Pages.getAll().length > 0) {
//                 editor.Pages.select(editor.Pages.getAll()[0]);
//                 editor.runCommand('canvas:reload');
//             }
            
//             if (selectedRedirectPage) {
//                 updateDirectFormsRedirect(editor, selectedRedirectPage);
//             }
//         }, 500);
//     }, [selectedRedirectPage, stages, stageId, slug, user]);

//     useEffect(() => {
//         return () => {
//             if (editorInstance) {
//                 editorInstance.destroy();
//                 setEditorInstance(null);
//                 delete window.editor;
//             }
//         };
//     }, [editorInstance]);

//     useEffect(() => {
//         const handleBeforeUnload = (event) => {
//             event.preventDefault();
//             event.returnValue = 'Really want to exit? Unsaved changes may be lost.';
//         };

//         window.addEventListener('beforeunload', handleBeforeUnload);

//         return () => {
//             window.removeEventListener('beforeunload', handleBeforeUnload);
//         };
//     }, []);

//     const generateInitialProject = useCallback(() => {
//         const savedProjectData = contentData.projectData;
//         const hasSavedPages = savedProjectData && savedProjectData.pages && Array.isArray(savedProjectData.pages) && savedProjectData.pages.length > 0;
    
//         const createPageFromTemplate = (stage) => {
//             const isCustom = stage.type === 'custom-page';
//             const config = isCustom
//                 ? contentData.customStagesConfig?.[stage.id]
//                 : contentData.stagesConfig?.[stage.type];
//             const templateSet = {
//                 'welcome-page': templates.welcomeTemplates, 'vsl-page': templates.vslTemplates,
//                 'thankyou-page': templates.thankyouTemplates, 'whatsapp-page': templates.whatsappTemplates,
//                 'product-offer': templates.productOfferTemplates, 'custom-page': templates.miscTemplates,
//                 'appointment-page': templates.appointmentTemplates, 'payment-page': templates.paymentTemplates,
//             }[stage.type];
//             const templateKey = config?.selectedTemplateKey;
//             let template = (templateKey && templateSet && templateSet[templateKey]) 
//                             ? templateSet[templateKey] 
//                             : (templateSet ? Object.values(templateSet)[0] : null);
    
//             if (!template) {
//                  return {
//                     id: stage.id,
//                     name: stage.name,
//                     component: `<h1>${stage.name}</h1><p>Template not configured for this stage type.</p>`,
//                     styles: '', 
//                     script: '',
//                     basicInfo: config?.basicInfo || {},
//                     redirectPage: config?.redirectPage || ''
//                 };
//             }
    
//            return {
//             id: stage.id,
//             name: stage.name,
//             component: template.html || `<h1>${stage.name}</h1><p>Template content not found.</p>`,
//             styles: template.css || '',
//             script: typeof template.js === 'function' ? template.js.toString() : template.js || '',
//             basicInfo: config?.basicInfo || {},
//             redirectPage: config?.redirectPage || ''
//         };
//     };

//     let pages;
//     let globalCss = '';

//     if (hasSavedPages) {
//         globalCss = savedProjectData.globalCss || '';
//         pages = stages.map(stage => {
//             const savedPage = savedProjectData.pages.find(p => p.id === stage.id);
//             return savedPage ? {
//                 id: stage.id,
//                 name: savedPage.name || stage.name,
//                 component: savedPage.html,
//                 styles: savedPage.css || '',
//                 script: savedPage.js || '',
//                 basicInfo: savedPage.basicInfo || {},
//                 redirectPage: savedPage.redirectPage || ''
//             } : createPageFromTemplate(stage);
//         });
//     } else {
//         pages = stages.map(stage => createPageFromTemplate(stage));
//     }

//     return { pages, css: globalCss };
// }, [stages, contentData, stageId]);

//     const applyDataToPage = (page, { html, css, js, basicInfo, redirectPage }) => {
//         if (!editorInstance || !page) return;
//         try {
//             if (html !== undefined) {
//                 page.set('component', '');
//                 page.set('component', html);
//             }
//             if (css !== undefined) {
//                 page.set('styles', css);
//                 const cssRules = editorInstance.CssComposer.getAll();
//                 const pageRules = cssRules.filter(rule => true);
//                 pageRules.forEach(rule => editorInstance.CssComposer.remove(rule));
//                 if (css.trim()) {
//                     editorInstance.CssComposer.setRule(css);
//                 }
//             }
//             if (js !== undefined) {
//                 page.set('script', typeof js === 'function' ? js.toString() : js);
//             }
//             if (basicInfo) {
//                 page.set('basicInfo', basicInfo);
//             }
//             if (redirectPage !== undefined) {
//                 page.set('redirectPage', redirectPage);
//                 setSelectedRedirectPage(redirectPage);
//                 updateDirectFormsRedirect(editorInstance, redirectPage);
//             }
//             editorInstance.Pages.select(page);
//             editorInstance.trigger('change:canvas');
//             editorInstance.runCommand('canvas:reload');
//         } catch (error) {
//             console.error(`Error applying data to page ${page.id}:`, error);
//         }
//     };

//     const extractContentForAI = (editor) => {
//         const content = [];
//         const page = editor.Pages.getSelected();
//         if (!page) return content;
//         const walkComponents = (component) => {
//             if (!component || !component.view || !component.view.el) return;
//             if (component.is('text') && component.toHTML().trim().length > 0) {
//                 content.push({ id: component.cid, type: 'text', content: component.toHTML() });
//             } else if (component.is('image')) {
//                 content.push({ id: component.cid, type: 'image', src: component.get('src') });
//             }
//             component.components().forEach(walkComponents);
//         };
//         walkComponents(page.getMainComponent());
//         return content;
//     };

//     const applyAIUpdates = (editor, updatedData) => {
//         if (!editor || !updatedData) return;
//         const currentPage = editor.Pages.getSelected();
//         if (!currentPage) return;

//         updatedData.forEach(item => {
//             const component = currentPage.getMainComponent().find(`#${item.id}`)[0];
//             if (component) {
//                 if (item.type === 'text' && item.content !== undefined) {
//                     component.components(item.content);
//                 } else if (item.type === 'image' && item.src !== undefined) {
//                     component.set('src', item.src);
//                 }
//             }
//         });
//         editor.trigger('change:canvas');
//         editor.runCommand('canvas:reload');
//     };

//     const handleAssetUpload = async (files, onResponse) => {
//         const formData = new FormData();
//         for (let i = 0; i < files.length; i++) {
//             formData.append('assets', files[i]);
//         }
//         try {
//             const response = await fetch(`${API_BASE_URL}/api/assets`, {
//                 method: 'POST',
//                 body: formData,
//             });
//             if (!response.ok) {
//                 const errData = await response.json();
//                 throw new Error(errData.error || 'Upload failed');
//             }
//             const result = await response.json();
//             onResponse(result.data);
//             setAssets(prevAssets => [...result.data, ...prevAssets]);
//         } catch (error) {
//             console.error('Upload error:', error);
//             alert(`Failed to upload files: ${error.message}`);
//             onResponse([]);
//         }
//     };

//     const extractPageCSS = (editor, pageId) => {
//         try {
//             const cssComposer = editor.CssComposer;
//             const allRules = cssComposer.getAll();
//             let pageCSS = '';
            
//             allRules.forEach(rule => {
//                 const selector = rule.get('selectors');
//                 const cssText = rule.toCSS();
//                 if (cssText && cssText.trim()) {
//                     pageCSS += cssText + '\n';
//                 }
//             });
            
//             return pageCSS.trim();
//         } catch (error) {
//             console.error('Error extracting page CSS:', error);
//             return '';
//         }
//     };

//     const handleSave = async (saveType) => {
//         if (!editorInstance) {
//             alert("Editor is not ready.");
//             return;
//         }

//         const editor = editorInstance;
//         const globalCss = editor.getCss();
//         const funnelName = contentData?.name || 'My Funnel';

//         const preparePageData = (page) => {
//             const stage = stages.find(s => s.id === page.id);
//             const pageCSS = extractPageCSS(editor, page.id);
//             const pageHTML = page.getMainComponent().toHTML();
            
//             // Add the form initialization script to pages that contain forms
//             const hasDirectForm = pageHTML.includes('bss-direct-form');
//             let finalHTML = pageHTML;
            
//             if (hasDirectForm) {
//                 const formScript = `
//                 <script>
//                 (function() {
//                     const initForms = () => {
//                         const forms = document.querySelectorAll('.bss-direct-form:not([data-initialized])');
//                         forms.forEach(form => {
//                             form.setAttribute('data-initialized', 'true');
//                             const container = form.closest('.bss-direct-form-container');
//                             const messageEl = container ? container.querySelector('.form-message') : null;
//                             const submitBtn = form.querySelector('.bss-submit-btn');
                            
//                             const showMessage = (message, type) => {
//                                 if (messageEl) {
//                                     messageEl.style.display = 'block';
//                                     messageEl.className = 'form-message ' + type;
//                                     messageEl.textContent = message;
//                                 } else {
//                                     alert(message);
//                                 }
//                             };

//                             const hideMessage = () => {
//                                 if (messageEl) {
//                                     messageEl.style.display = 'none';
//                                     messageEl.textContent = '';
//                                 }
//                             };
                            
//                             form.querySelectorAll('input').forEach(input => {
//                                 input.addEventListener('focus', hideMessage);
//                             });
                            
//                             form.addEventListener('submit', async function(e) {
//                                 e.preventDefault();
//                                 const originalText = submitBtn.innerHTML;
//                                 submitBtn.innerHTML = '<span>Processing...</span>';
//                                 submitBtn.disabled = true;
//                                 hideMessage();
                                
//                                 const redirectPage = this.getAttribute('data-redirect-page') || container.getAttribute('data-redirect-page');
                                
//                                 try {
//                                     const formData = {
//                                         name: this.querySelector('input[name="name"]').value,
//                                         email: this.querySelector('input[name="email"]').value,
//                                         phone: this.querySelector('input[name="phone"]').value,
//                                         timestamp: new Date().toISOString(),
//                                         source: 'Direct Form'
//                                     };
                                    
//                                     console.log('Form submitted:', formData);
//                                     await new Promise(resolve => setTimeout(resolve, 1500));
//                                     showMessage('Thank you! Your submission was successful!', 'success');
                                    
//                                     if (redirectPage && redirectPage.trim()) {
//                                         setTimeout(() => {
//                                             let redirectUrl;
//                                             if (redirectPage.startsWith('http')) {
//                                                 redirectUrl = redirectPage;
//                                             } else if (redirectPage.startsWith('/')) {
//                                                 redirectUrl = redirectPage;
//                                             } else {
//                                                 const pathParts = window.location.pathname.split('/').filter(Boolean);
                                            
//                                                 const funnelSlug = pathParts.length >= 2 ? pathParts[1] : 'funnel';
//                                                 redirectUrl = '/funnels/' + funnelSlug + '/' + redirectPage;
//                                             }
//                                             console.log('Redirecting to:', redirectUrl);
//                                             window.location.href = redirectUrl;
//                                         }, 2000);
//                                     }
                                    
//                                     setTimeout(() => this.reset(), 3000);
                                    
//                                 } catch (error) {
//                                     console.error('Error:', error);
//                                     showMessage('Sorry, there was an error. Please try again.', 'error');
//                                 } finally {
//                                     setTimeout(() => {
//                                         submitBtn.innerHTML = originalText;
//                                         submitBtn.disabled = false;
//                                     }, 1000);
//                                 }
//                             });
//                         });
//                     };
                    
//                     if (document.readyState === 'loading') {
//                         document.addEventListener('DOMContentLoaded', initForms);
//                     } else {
//                         initForms();
//                     }
//                 })();
//                 </script>`;
                
//                 finalHTML += formScript;
//             }
            
//             return {
//                 id: page.id,
//                 name: page.get('name') || stage?.name || 'Unnamed Page',
//                 type: stage?.type || 'custom-page',
//                 html: finalHTML,
//                 css: pageCSS,
//                 js: page.get('script') || '',
//                 assets: [],
//                 basicInfo: page.get('basicInfo') || {},
//                 redirectPage: page.get('redirectPage') || selectedRedirectPage || '',
//                 isEnabled: stage?.isEnabled !== false,
//                 order: stages.findIndex(s => s.id === page.id)
//             };
//         };

//         try {
//             let pagesData;
//             if (saveType === 'single') {
//                 const currentPage = editor.Pages.getSelected();
//                 if (!currentPage) {
//                     alert("No page is selected to save.");
//                     return;
//                 }
//                 pagesData = [preparePageData(currentPage)];
//             } else {
//                 pagesData = editor.Pages.getAll().map(preparePageData);
//             }

//             dispatch(updateProjectData({
//                 pages: pagesData,
//                 globalCss: globalCss
//             }));

//             const response = await dispatch(saveFunnelToBackend({ 
//                 slug, 
//                 funnelName 
//             }));

//             if (saveFunnelToBackend.fulfilled.match(response)) {
//                 alert(saveType === 'single' ? "Page saved successfully!" : "All pages saved successfully!");
//             } else {
//                 throw new Error(response.error?.message || 'Failed to save');
//             }
//         } catch (error) {
//             console.error('Save error:', error);
//             alert(`Failed to save data: ${error.message}`);
//         }
//     };

//     const handleDownloadProject = () => {
//         if (!editorInstance) { alert("Editor is not ready."); return; }
//         const editor = editorInstance;
//         const currentPage = editor.Pages.getSelected();
//         if (!currentPage) { alert("No page is selected to download."); return; }
//         const pageName = currentPage.get('name') || `page-${currentPage.cid}`;
        
//         const pageCSS = extractPageCSS(editor, currentPage.id);
//         const globalCSS = editor.getCss();
//         const combinedCSS = globalCSS + '\n' + pageCSS;
        
//         const fullCode = `<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>${pageName}</title><style>${combinedCSS}</style></head><body>${currentPage.getMainComponent().toHTML()}<script>${currentPage.get('script') || ''}</script></body></html>`;
//         const blob = new Blob([fullCode], { type: 'text/html' });
//         const a = document.createElement('a');
//         a.href = URL.createObjectURL(blob);
//         a.download = `${pageName.toLowerCase().replace(/\s+/g, '-')}.html`;
//         a.click();
//         URL.revokeObjectURL(a.href);
//     };

//     const handleAISubmit = async ({ description }) => {
//         if (!editorInstance) { alert("Editor not available."); return; }
//         const page = editorInstance.Pages.getSelected();
//         if (!page) { alert("Please select a page first."); return; }

//         setIsAILoading(true);
//         const contentToUpdate = extractContentForAI(editorInstance);
//         if (contentToUpdate.length === 0) {
//             alert("No text or image content found on this page to update.");
//             setIsAILoading(false);
//             return;
//         }

//         const requestBody = { description, contentToUpdate, pageInfo: { id: page.id, name: page.get('name') } };

//         try {
//             const response = await fetch(`${API_BASE_URL}/api/ai/generate-content`, {
//                 method: 'POST',
//                 headers: { 'Content-Type': 'application/json' },
//                 body: JSON.stringify(requestBody)
//             });

//             if (!response.ok) {
//                 throw new Error(`Server responded with status: ${response.status}`);
//             }

//             const aiResponse = await response.json();
//             applyAIUpdates(editorInstance, aiResponse.updatedContent);
//             alert("Content updated successfully by AI!");

//         } catch (error) {
//             console.error('AI Generation Error:', error);
//             alert(`Failed to update content: ${error.message}`);
//         } finally {
//             setIsAILoading(false);
//             setShowAIPopup(false);
//         }
//     };

//     const handleTemplateSelect = (templateKey) => {
//         if (!currentStage || !editorInstance) return;
//         const templateSet = {
//             'welcome-page': templates.welcomeTemplates, 'vsl-page': templates.vslTemplates,
//             'thankyou-page': templates.thankyouTemplates, 'whatsapp-page': templates.whatsappTemplates,
//             'product-offer': templates.productOfferTemplates, 'custom-page': templates.miscTemplates,
//             'appointment-page': templates.appointmentTemplates, 'payment-page': templates.paymentTemplates,
//         }[currentStage.type];
//         const template = templateSet?.[templateKey];
//         if (!template) { console.error('Template not found:', templateKey); return; }
//         dispatch(setSelectedTemplateForStage({ stageId: currentStage.id, templateKey, stageType: currentStage.type }));
//         const page = editorInstance.Pages.get(currentStage.id);
//         if (page) {
//             applyDataToPage(page, { 
//                 html: template.html, 
//                 css: template.css, 
//                 js: template.js, 
//                 basicInfo: template.basicInfo || {},
//                 redirectPage: template.redirectPage || ''
//             });
//         }
//         setShowTemplateSelector(false);
//     };

//     const handleRedirectSelect = (pageSlug) => {
//         const formattedSlug = pageSlug.replace(/^\/|\/$/g, '');
//         console.log('Setting redirect page to:', formattedSlug);
        
//         setSelectedRedirectPage(formattedSlug);
        
//         if (editorInstance) {
//             const currentPage = editorInstance.Pages.getSelected();
//             if (currentPage) {
//                 currentPage.set('redirectPage', formattedSlug);
//                 console.log('Updated current page redirect to:', formattedSlug);
//             }
            
//             updateDirectFormsRedirect(editorInstance, formattedSlug);
            
//             setTimeout(() => {
//                 updateDirectFormsRedirect(editorInstance, formattedSlug);
//             }, 500);
            
//             if (currentStage) {
//                 const updateData = {
//                     stageId: currentStage.id,
//                     stageType: currentStage.type,
//                     basicInfo: currentStage.basicInfo || {},
//                     redirectPage: formattedSlug
//                 };
                
//                 dispatch(updateStageBasicInfo(updateData));
//                 console.log('Dispatched redirect page update to Redux:', updateData);
//             }
//         }
        
//         alert(`Redirect page set to: ${formattedSlug}\nAll direct forms will now redirect to this page after submission.`);
//     };

//     const openTemplateSelector = (stage) => { setCurrentStage(stage); setShowTemplateSelector(true); };
//     const getSelectedTemplateKey = () => {
//         if (!currentStage) return null;
//         const config = currentStage.type === 'custom-page'
//             ? contentData.customStagesConfig?.[currentStage.id]
//             : contentData.stagesConfig?.[currentStage.type];
//         return config?.selectedTemplateKey;
//     };
//     const forceTemplateRefresh = () => {
//         if (window.confirm("Are you sure? This will reload all pages from their initial templates and discard unsaved changes.")) {
//             setForceRefreshKey(prev => prev + 1);
//         }
//     };

//     const handleBack = () => {
//         if (window.confirm('Really want to exit? Unsaved changes may be lost.')) {
//             dispatch(resetState());
//             navigate(`/dashboard/Funnel_settings/${slug}`);
//         }
//     };

//     const editorKey = `funnel-editor-${slug}-${forceRefreshKey}`;

//     if (apiStatus === 'loading') {
//         return (
//             <div className="portfolio-edit-container" style={{ display: 'flex', justifyContent: 'center', alignItems: 'center', height: '100vh' }}>
//                 <h2>Loading Funnel Editor...</h2>
//             </div>
//         );
//     }

//     if (apiStatus === 'failed') {
//         return (
//             <div className="portfolio-edit-container" style={{ display: 'flex', justifyContent: 'center', alignItems: 'center', height: '100vh' }}>
//                 <h2>Error loading funnel. Please try again.</h2>
//             </div>
//         );
//     }

//     return (
//         <div className="portfolio-edit-container">
//             {showTemplateSelector && currentStage && (
//                 <div className="modal-overlay">
//                     <div className="modal-content">
//                         <button className="modal-close-btn" onClick={() => setShowTemplateSelector(false)}>Ã—</button>
//                         <StageTemplateSelector
//                             stageType={currentStage.type}
//                             selectedKey={getSelectedTemplateKey()}
//                             onSelect={handleTemplateSelect}
//                         />
//                     </div>
//                 </div>
//             )}

//             {showAIPopup && (
//                 <div className="modal-overlay">
//                     <div className="modal-content ai-modal-content">
//                         <AIGenerativePopup
//                             isLoading={isAILoading}
//                             onClose={() => setShowAIPopup(false)}
//                             onSubmit={handleAISubmit}
//                         />
//                     </div>
//                 </div>
//             )}

//             {showRedirectPopup && (
//                 <div className="modal-overlay">
//                     <div className="modal-content">
//                         <button className="modal-close-btn" onClick={() => setShowRedirectPopup(false)}>Ã—</button>
//                         <RedirectPageSelector
//                             stages={stages}
//                             currentStageId={stageId}
//                             onSelect={handleRedirectSelect}
//                             onClose={() => setShowRedirectPopup(false)}
//                         />
//                     </div>
//                 </div>
//             )}

//             <div className="action-buttons">
//                 <button onClick={() => handleSave('single')} className="action-button save-button">
//                     <FaSave /> <span>Save Page</span>
//                 </button>
//                 <button onClick={() => handleSave('all')} className="action-button save-all-button">
//                     <FaFileExport /> <span>Save All</span>
//                 </button>
//                 <button onClick={() => setShowAIPopup(true)} className="action-button ai-generate-button">
//                     <FaMagic /> <span>AI Content</span>
//                 </button>
//                 <button onClick={() => setShowRedirectPopup(true)} className="action-button redirect-button">
//                     <FaFileAlt /> <span>Set Redirect</span>
//                 </button>
//                 <button onClick={forceTemplateRefresh} className="action-button refresh-button">
//                     <FaSync /> <span>Refresh</span>
//                 </button>
//                 <button onClick={handleDownloadProject} className="action-button download-button">
//                     <FaDownload /> <span>Download</span>
//                 </button>
//                 <button onClick={handleBack} className="action-button back-button">
//                     <FaArrowLeft /> <span>Back</span>
//                 </button>
//             </div>

//             <div className="editor-main-area" style={{ width: '100%', height: '100%' }}>
//                 <div id="pages" className="pages-container" />
//                 <StudioEditor
//                     key={editorKey}
//                     onEditor={onEditorReady}
//                     style={{ width: "100%", height: "100%" }}
//                     options={{
//                         storage: {
//                             type: "self",
//                             onSave: async ({ project }) => console.log("[Frontend] Project auto-synced (GrapesJS internal).", project),
//                             onLoad: () => ({ project: generateInitialProject() }),
//                         },
//                         assetManager: {
//                             assets: assets.map(asset => ({
//                                 ...asset,
//                                 src: asset.src.startsWith('/') ? asset.src : `/${asset.src}`
//                             })),
//                             upload: `${API_BASE_URL}/api/assets`,
//                             uploadName: 'assets',
//                             multiUpload: true,
//                             customUpload: async (files, onComplete, onError) => {
//                                 try {
//                                     const uploaded = await uploadFiles(files);
//                                     onComplete(uploaded.map(asset => ({
//                                         ...asset,
//                                         src: asset.src.startsWith('/') ? asset.src : `/${asset.src}`
//                                     })));
//                                     setAssets(prev => [...uploaded, ...prev]);
//                                 } catch (err) {
//                                     console.error(err);
//                                     onError(err.message);
//                                 }
//                             },
//                         },
//                         plugins: [
//                             gjsForms, gjsCountdown, gjsTabs, gjsCustomCode,
//                             gjsTooltip, gjsTyped, gjsNavbar, gjsBlocksBasic,
//                         ],
//                     }}
//                 />
//             </div>

//             <style jsx>{`
//                 /* --- Main Layout --- */
//                 .portfolio-edit-container {
//                     display: flex;
//                     height: 100vh; 
//                     width: 100vw;
//                     position: relative; 
//                     overflow: hidden;
//                     font-family: 'Segoe UI', Tahoma, sans-serif;
//                     background-color: #f0f2f5;
//                 }
//                 .editor-main-area {
//                     flex-grow: 1;
//                     position: relative;
//                     height: 100%;
//                 }
//                 .pages-container {
//                     position: absolute; 
//                     top: 15px; 
//                     left: 15px;
//                     z-index: 1000; 
//                     background: rgba(30, 30, 30, 0.9);
//                     color: white;
//                     padding: 8px; 
//                     border-radius: 8px;
//                     box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
//                 }

//                 /* --- Action Buttons --- */
//                 .action-buttons {
//                     position: fixed; 
//                     bottom: 20px; 
//                     right: 20px;
//                     z-index: 1001; 
//                     display: flex;
//                     flex-direction: column; 
//                     gap: 12px;
//                 }
//                 .action-button {
//                     padding: 12px 18px; 
//                     border: none; 
//                     border-radius: 8px;
//                     font-weight: 600; 
//                     cursor: pointer;
//                     transition: all 0.2s ease;
//                     box-shadow: 0 2px 5px rgba(0,0,0,0.1);
//                     display: flex; 
//                     align-items: center; 
//                     gap: 10px; 
//                     font-size: 14px;
//                 }
//                 .action-button:hover {
//                     transform: translateY(-3px);
//                     box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
//                 }
//                 .action-button > svg { 
//                     font-size: 1.1rem; 
//                 }
//                 .save-button { background-color: #3498db; color: white; }
//                 .save-all-button { background-color: #16a085; color: white; }
//                 .ai-generate-button { background-color: #8e44ad; color: white; }
//                 .redirect-button { background-color: #2ecc71; color: white; }
//                 .refresh-button { background-color: #f39c12; color: white; }
//                 .download-button { background-color: #27ae60; color: white; }
//                 .back-button { background-color: #c0392b; color: white; }

//                 /* --- Modal Styles --- */
//                 .modal-overlay {
//                     position: fixed; top: 0; left: 0;
//                     width: 100%; height: 100%;
//                     background-color: rgba(0, 0, 0, 0.6);
//                     display: flex; justify-content: center; align-items: center;
//                     z-index: 2000;
//                 }
//                 .modal-content {
//                     background: white; padding: 25px; border-radius: 10px;
//                     box-shadow: 0 5px 15px rgba(0,0,0,0.3);
//                     max-width: 90vw; max-height: 90vh;
//                     overflow-y: auto; position: relative;
//                 }
//                 .modal-close-btn {
//                     position: absolute; top: 10px; right: 15px;
//                     background: transparent; border: none;
//                     font-size: 24px; cursor: pointer; color: #888;
//                 }
//                 .cancel{
//                     background-color: #4a5568 !important;
//                     color: #e0e6ed;
//                     border: 1px solid #5a6b7d;
//                     padding: 12px 25px;
//                     border-radius: 10px;
//                     font-size: 15px;
//                     font-weight: 700;
//                     cursor: pointer;
//                     transition: all 0.3s ease-in-out, transform 0.2s ease-out;
//                     letter-spacing: 0.3px;
//                     box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
//                 }
//                 .ai-modal-content { max-width: 550px; }

//                 /* --- Redirect Popup Styles --- */
//                 .redirect-popup-content {
//                     min-width: 400px;
//                     max-width: 500px;
//                 }
//                 .redirect-popup-content h3 {
//                     margin-top: 0;
//                     color: #2c3e50;
//                 }
//                 .redirect-popup-content p {
//                     color: #7f8c8d;
//                     margin-bottom: 20px;
//                 }
//                 .redirect-popup-content select {
//                     width: 100%;
//                     padding: 10px;
//                     border: 1px solid #ddd;
//                     border-radius: 4px;
//                     font-size: 14px;
//                 }
//                 .popup-buttons {
//                     display: flex;
//                     justify-content: flex-end;
//                     gap: 10px;
//                     margin-top: 20px;
//                 }
//                 .popup-buttons button {
//                     padding: 8px 16px;
//                     border-radius: 4px;
//                     cursor: pointer;
//                 }
//                 .cancel-btn {
//                     background-color: #e74c3c;
//                     color: white;
//                     border: none;
//                 }
//                 .submit-btn {
//                     background-color: #2ecc71;
//                     color: white;
//                     border: none;
//                 }

//                 /* --- AI Popup Specific Styles --- */
//                 .ai-popup-content h3 { margin-top: 0; color: #333; }
//                 .ai-popup-content p { color: #555; margin-bottom: 20px; }
//                 .description-section { margin-top: 15px; }
//                 .description-section label { display: block;color:black; margin-bottom: 8px; font-weight: 500; }
//                 .description-section textarea { width: 100%; color:black; padding: 10px; border-radius: 5px; border: 1px solid #ccc; resize: vertical; box-sizing: border-box; }
//                 .ai-popup-buttons { display: flex; justify-content: flex-end; gap: 10px; margin-top: 25px; }
//                 .ai-popup-buttons button { padding: 10px 20px; border-radius: 5px; border: none; font-weight: 500; cursor: pointer; }
//                 .ai-cancel-btn { background-color: #eee; }
//                 .ai-submit-btn { background-color: #4f46e5; color: white; }
//                 .ai-submit-btn:disabled { background-color: #ccc; cursor: not-allowed; }

//                 /* --- Template Selector Styles --- */
//                 .template-selector-container { width: 90vw; max-width: 1200px; }
//                 .template-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; }
//                 .template-card { border: 2px solid transparent; border-radius: 8px; overflow: hidden; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
//                 .template-card:hover { transform: translateY(-5px); box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
//                 .template-card.selected { border-color: #3498db; box-shadow: 0 0 10px rgba(52, 152, 219, 0.5); }
//                 .template-thumbnail img { width: 100%; height: auto; display: block; background-color: #eee; }
//                 .template-info { padding: 15px; }
//                 .template-info h4 { margin: 0 0 8px 0; font-size: 16px; }
//                 .template-info p { margin: 0; font-size: 14px; color: #666; }
//                 .main-content.fixed-sidebar { margin-left:0px; }
//             `}</style>
//         </div>
//     );
// };

// export default PortfolioEdit;

import React, { useEffect, useState, useCallback } from 'react';
import { useSelector, useDispatch } from 'react-redux';
import StudioEditor from "@grapesjs/studio-sdk/react";
import "@grapesjs/studio-sdk/style";
import { useParams, useNavigate } from 'react-router-dom';
import { FaSync, FaDownload, FaArrowLeft, FaMagic, FaFileAlt, FaSave, FaFileExport } from 'react-icons/fa';
import axios from "axios";

import { updateProjectData, setSelectedTemplateForStage, updateStageBasicInfo, saveFunnelToBackend, fetchFunnelBySlug, resetState } from '../../../../redux/funnel.jsx';
import { templates } from './df_temp.jsx';
import addLandingPageComponents from './function.jsx';
import "./old.css";

// GrapesJS Plugins
import gjsPresetWebpage from "grapesjs-preset-webpage";
import gjsForms from "grapesjs-plugin-forms";
import gjsCountdown from "grapesjs-component-countdown";
import gjsTabs from "grapesjs-tabs";
import gjsCustomCode from "grapesjs-custom-code";
import gjsTooltip from "grapesjs-tooltip";
import gjsTyped from "grapesjs-typed";
import gjsNavbar from "grapesjs-navbar";
import gjsBlocksBasic from "grapesjs-blocks-basic";

//** Redirect Page Selector Popup **//
const RedirectPageSelector = ({ stages, currentStageId, onSelect, onClose }) => {
    const [selectedPage, setSelectedPage] = useState('');

    const handleSubmit = (e) => {
        e.preventDefault();
        if (!selectedPage) {
            alert('Please select a redirect page');
            return;
        }
        onSelect(selectedPage);
        onClose();
    };

    return (
        <div className="redirect-popup-content">
            <h3>Select Redirect Page</h3>
            <p>Choose where users should be redirected after form submission:</p>
            
            <form onSubmit={handleSubmit}>
                <div className="form-group">
                    <select 
                        value={selectedPage} 
                        onChange={(e) => setSelectedPage(e.target.value)}
                        required
                    >
                        <option value="">-- Select a page --</option>
                        {stages
                            .filter(stage => stage.id !== currentStageId)
                            .map(stage => (
                                <option key={stage.id} value={stage.slug || stage.id}>
                                    {stage.name} ({stage.type})
                                </option>
                            ))}
                    </select>
                </div>
                
                <div className="popup-buttons">
                    <button type="button" onClick={onClose} className="cancel-btn">
                        Cancel
                    </button>
                    <button type="submit" className="submit-btn">
                        Set Redirect
                    </button>
                </div>
            </form>
        </div>
    );
};

//** Template Selector Component **//
const StageTemplateSelector = ({ stageType, selectedKey, onSelect }) => {
    const templateSet = {
        'welcome-page': templates.welcomeTemplates,
        'vsl-page': templates.vslTemplates,
        'thankyou-page': templates.thankyouTemplates,
        'whatsapp-page': templates.whatsappTemplates,
        'product-offer': templates.productOfferTemplates,
        'custom-page': templates.miscTemplates,
        'appointment-page': templates.appointmentTemplates,
        'payment-page': templates.paymentTemplates,
    }[stageType];

    if (!templateSet || Object.keys(templateSet).length === 0) {
        return (
            <div className="no-templates-message">
                <p>No templates available for this stage type.</p>
            </div>
        );
    }

    return (
        <div className="template-selector-container">
            <h3 className="template-selector-title">Select a Template</h3>
            <div className="template-grid">
                {Object.entries(templateSet).map(([key, template]) => (
                    <div
                        key={key}
                        className={`template-card ${selectedKey === key ? 'selected' : ''}`}
                        onClick={() => onSelect(key)}
                    >
                        <div className="template-thumbnail">
                            <img
                                src={template.thumbnail}
                                alt={template.name}
                                onError={(e) => {
                                    e.target.onerror = null;
                                    e.target.src = 'https://placehold.co/400x300/ccc/ffffff?text=No+Image';
                                }}
                            />
                        </div>
                        <div className="template-info">
                            <h4>{template.name}</h4>
                            <p>{template.description}</p>
                        </div>
                    </div>
                ))}
            </div>
        </div>
    );
};

//** AI Generative Popup Component **//
const AIGenerativePopup = ({ onClose, onSubmit, isLoading }) => {
    const [description, setDescription] = useState('');

    const handleSubmit = () => {
        if (!description.trim()) {
            alert('Please provide a description for the content you want to generate.');
            return;
        }
        onSubmit({ description });
    };

    return (
        <div className="ai-popup-content">
            <h3>AI Content Generation</h3>
            <p>Describe the changes you want to make to the content:</p>

            <div className="description-section">
                <label>Describe what you want:</label>
                <textarea
                    value={description}
                    onChange={(e) => setDescription(e.target.value)}
                    placeholder="e.g., 'Make the headline more exciting and shorten the paragraph about benefits.'"
                    rows={4}
                />
            </div>

            <div className="ai-popup-buttons">
                <button onClick={onClose} className="ai-cancel-btn cancel" disabled={isLoading}>
                    Cancel
                </button>
                <button
                    onClick={handleSubmit}
                    className="ai-submit-btn upload"
                    disabled={isLoading || !description.trim()}
                >
                    {isLoading ? 'Generating...' : 'Update Content'}
                </button>
            </div>
        </div>
    );
};

//** Main Editor Component **//
const PortfolioEdit = () => {
    const dispatch = useDispatch();
    const navigate = useNavigate();
    const { slug, stageId } = useParams();

    const { contentData, stages, apiStatus, funnelId } = useSelector((state) => state.funnel);
    const { user } = useSelector((state) => state.auth);
    const API_BASE_URL = window.API_BASE_URL || 'http://localhost:5000';

    const [editorInstance, setEditorInstance] = useState(null);
    const [showTemplateSelector, setShowTemplateSelector] = useState(false);
    const [showAIPopup, setShowAIPopup] = useState(false);
    const [showRedirectPopup, setShowRedirectPopup] = useState(false);
    const [isAILoading, setIsAILoading] = useState(false);
    const [currentStage, setCurrentStage] = useState(null);
    const [forceRefreshKey, setForceRefreshKey] = useState(0);
    const [assets, setAssets] = useState([]);
    const [selectedRedirectPage, setSelectedRedirectPage] = useState('');

    useEffect(() => {
        if (typeof window !== 'undefined') {
            window.reduxStore = {
                getState: () => ({
                    funnel: {
                        stages: stages,
                        contentData: contentData
                    }
                })
            };
        }
        
        return () => {
            if (typeof window !== 'undefined') {
                delete window.reduxStore;
            }
        };
    }, [stages, contentData]);

    useEffect(() => {
        if (slug) {
            dispatch(fetchFunnelBySlug(slug));
        }
    }, [dispatch, slug]);

    useEffect(() => {
        if (stages && stageId) {
            const stage = stages.find(s => s.id === stageId);
            if (stage) {
                setCurrentStage(stage);
                const stageConfig = contentData.stagesConfig?.[stage.type] || 
                                  contentData.customStagesConfig?.[stage.id];
                if (stageConfig?.redirectPage) {
                    setSelectedRedirectPage(stageConfig.redirectPage);
                }
            }
        }
    }, [stages, stageId, contentData]);

    const uploadFiles = async files => {
        const fd = new FormData();
        files.forEach(f => fd.append('assets', f));
      
        try {
            const { data } = await axios.post(`${API_BASE_URL}/api/assets`, fd, {
                headers: {
                    'Content-Type': 'multipart/form-data'
                }
            });
            return data.data.map(asset => ({
                ...asset,
                src: asset.src.startsWith('/') ? asset.src : `/${asset.src}`
            }));
        } catch (error) {
            console.error('Upload error:', error);
            throw error;
        }
    };

    useEffect(() => {
        const fetchInitialAssets = async () => {
            try {
                const response = await fetch(`${API_BASE_URL}/api/assets?userId=${user?.name || 'guest'}`);
                if (!response.ok) {
                    throw new Error(`Failed to fetch assets: ${response.statusText}`);
                }
                const result = await response.json();
                setAssets(result.data || []);
            } catch (error) {
                console.error("Error fetching initial assets:", error);
                setAssets([]);
            }
        };
        fetchInitialAssets();
    }, []);

    // Function to update direct forms with redirect URL (updated to handle both form types)
    const updateDirectFormsRedirect = (editor, redirectSlug) => {
        if (!editor || !redirectSlug) return;
        
        setTimeout(() => {
            const wrapper = editor.DomComponents.getWrapper();
            // Update both original and V2 forms
            const directContainers = wrapper.find('.bss-direct-form-container, .bss-direct-form-v2-container');
            
            let updatedCount = 0;
            directContainers.forEach(container => {
                const form = container.find('.bss-direct-form, .bss-direct-form-v2').at(0);
                if (form) {
                    form.addAttributes({ 'data-redirect-page': redirectSlug });
                    
                    const view = form.getView();
                    if (view && view.el) {
                        view.el.setAttribute('data-redirect-page', redirectSlug);
                    }
                    
                    updatedCount++;
                    console.log('Updated direct form redirect to:', redirectSlug);
                }
            });
            
            console.log(`Updated ${updatedCount} direct forms with redirect: ${redirectSlug}`);
            
            editor.trigger('change:canvas');
            editor.runCommand('canvas:reload');
        }, 100);
    };

    // Initialize form handlers globally with API integration (updated to handle both form types)
    const initializeDirectFormHandlers = () => {
        const initializeAllForms = () => {
            const forms = document.querySelectorAll('.bss-direct-form:not([data-initialized]), .bss-direct-form-v2:not([data-initialized])');
            
            forms.forEach(form => {
                form.setAttribute('data-initialized', 'true');
                
                const container = form.closest('.bss-direct-form-container, .bss-direct-form-v2-container');
                const messageEl = container ? container.querySelector('.form-message') : null;
                const submitBtn = form.querySelector('.bss-submit-btn, .bss-submit-btn-v2');
                
                const showMessage = (message, type) => {
                    if (messageEl) {
                        messageEl.style.display = 'block';
                        messageEl.className = 'form-message ' + type;
                        messageEl.textContent = message;
                        messageEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    } else {
                        console.log(type.toUpperCase() + ': ' + message);
                        alert(message);
                    }
                };

                const hideMessage = () => {
                    if (messageEl) {
                        messageEl.style.display = 'none';
                        messageEl.textContent = '';
                    }
                };
                
                const inputs = form.querySelectorAll('input');
                inputs.forEach(input => {
                    input.addEventListener('focus', hideMessage);
                });
                
                form.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    if (!submitBtn) return;
                    
                    const originalText = submitBtn.innerHTML;
                    submitBtn.innerHTML = '<span>Processing...</span>';
                    submitBtn.disabled = true;
                    hideMessage();
                    
                    const redirectPage = this.getAttribute('data-redirect-page') || 
                                       container.getAttribute('data-redirect-page');
                    
                    try {
                        // Get form data including new city and country fields
                        const formData = {
                            name: this.querySelector('input[name="name"]').value,
                            email: this.querySelector('input[name="email"]').value,
                            phone: this.querySelector('input[name="phone"]').value,
                            city: this.querySelector('input[name="city"]').value,
                            country: this.querySelector('input[name="country"]').value,
                            coachId: user?.id,
                            funnelId: funnelId || 'default-funnel-id'
                        };
                        
                        console.log('ðŸ“ FORM SUBMISSION:', formData);
                        
                        // Validate required fields
                        if (!formData.name.trim() || !formData.email.trim() || !formData.phone.trim()) {
                            throw new Error('Name, email and phone are required');
                        }
                        
                        if (!formData.coachId) {
                            throw new Error('Coach information not available');
                        }
                        
                        // API call to create lead
                        const response = await axios.post('https://api.funnelseye.com/api/leads', {
                            name: formData.name.trim(),
                            email: formData.email.trim(),
                            phone: formData.phone.trim(),
                            city: formData.city.trim(),
                            country: formData.country.trim(),
                            coachId: formData.coachId,
                            funnelId: formData.funnelId
                        }, {
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        if (response.data.success) {
                            showMessage('ðŸŽ‰ Thank you! Your submission was successful!', 'success');
                            
                            setTimeout(() => {
                                if (redirectPage && redirectPage.trim() !== '') {
                                    console.log('Redirecting to:', redirectPage);
                                    
                                    let redirectUrl;
                                    if (redirectPage.startsWith('http')) {
                                        redirectUrl = redirectPage;
                                    } else if (redirectPage.startsWith('/')) {
                                        redirectUrl = redirectPage;
                                    } else {
                                        const currentPath = window.location.pathname;
                                        const pathParts = currentPath.split('/').filter(Boolean);
                                        const funnelSlug = pathParts[0] || 'funnel';
                                        redirectUrl = `/${funnelSlug}/${redirectPage}`;
                                    }
                                    
                                    console.log('Final redirect URL:', redirectUrl);
                                    setTimeout(() => {
                                        window.location.href = redirectUrl;
                                    }, 2000);
                                }
                            }, 1000);
                            
                            setTimeout(() => {
                                this.reset();
                            }, 3000);
                        } else {
                            throw new Error(response.data.message || 'Failed to submit form');
                        }
                        
                    } catch (error) {
                        console.error('Form submission error:', error);
                        showMessage(error.response?.data?.message || error.message || 'Sorry, there was an error. Please try again.', 'error');
                    } finally {
                        setTimeout(() => {
                            if (submitBtn) {
                                submitBtn.innerHTML = originalText;
                                submitBtn.disabled = false;
                            }
                        }, 1000);
                    }
                });
            });
        };
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeAllForms);
        } else {
            initializeAllForms();
        }
        
        setTimeout(initializeAllForms, 1000);
    };

    const onEditorReady = useCallback((editor) => {
        window.editor = editor;
        setEditorInstance(editor);
 const getPageElements = () => {
        const elements = [{ id: '', name: '-- Select element --' }];
        const currentPage = editor.Pages.getSelected();
        
        if (currentPage) {
            const walkComponents = (component) => {
                if (!component) return;
                
                const id = component.getId();
                if (id) {
                    const tagName = component.get('tagName') || 'div';
                    elements.push({
                        id: `#${id}`,
                        name: `${tagName}#${id}`
                    });
                }
                
                component.components().forEach(walkComponents);
            };
            
            walkComponents(currentPage.getMainComponent());
        }
        
        return elements;
    };

    // Link component configuration
    editor.DomComponents.addType('link', {
        model: {
            defaults: {
                traits: [
                    {
                        name: 'title',
                        label: 'Title'
                    },
                    {
                        name: 'target',
                        type: 'select',
                        label: 'Target',
                        options: [
                            { id: '', name: 'This window' },
                            { id: '_blank', name: 'New window' }
                        ]
                    },
                    // Manual URL input
                    {
                        type: 'text',
                        label: 'URL',
                        name: 'href',
                        placeholder: 'Enter URL or use options below'
                    },
                    // Page selector dropdown
                    {
                        type: 'select',
                        label: 'Link to Page',
                        name: 'pageLink',
                        options: [
                            { id: '', name: '-- Select a page --' },
                            ...stages
                                .filter(stage => stage.id !== stageId)
                                .map(stage => ({
                                    id: stage.id,
                                    name: `${stage.name} (${stage.type})`
                                }))
                        ],
                        changeProp: 1
                    },
                    // Element ID selector for anchors (now dynamic)
                    {
                        type: 'select',
                        label: 'Link to Element',
                        name: 'anchorLink',
                        options: getPageElements(),
                        changeProp: 1
                    }
                ]
            },
            
            init() {
                this.on('change:pageLink', this.handlePageLink);
                this.on('change:anchorLink', this.handleAnchorLink);
            },
            
            handlePageLink() {
                const pageId = this.get('pageLink');
                if (pageId) {
                    const newHref = `${pageId}`;
                    this.addAttributes({ href: newHref });
                    console.log('Page link set to:', newHref);
                    // Clear anchor selection
                    this.set('anchorLink', '');
                }
            },
            
            handleAnchorLink() {
                const anchorId = this.get('anchorLink');
                if (anchorId) {
                    this.addAttributes({ href: anchorId });
                    console.log('Anchor link set to:', anchorId);
                    // Clear page selection
                    this.set('pageLink', '');
                }
            }
        }
    });

    // Button component with link functionality (updated with dynamic element options)
    editor.DomComponents.addType('button', {
        extend: 'text',
        isComponent: el => el.tagName === 'BUTTON',
        model: {
            defaults: {
                tagName: 'button',
                traits: [
                    {
                        type: 'text',
                        label: 'Button Text',
                        name: 'content',
                        changeProp: 1
                    },
                    {
                        type: 'select',
                        label: 'Button Type',
                        name: 'type',
                        options: [
                            { id: 'button', name: 'Button' },
                            { id: 'submit', name: 'Submit' },
                            { id: 'reset', name: 'Reset' }
                        ]
                    },
                    {
                        type: 'checkbox',
                        label: 'Make it a Link',
                        name: 'makeLink',
                        changeProp: 1
                    },
                    {
                        type: 'text',
                        label: 'Link URL',
                        name: 'linkUrl',
                        placeholder: 'Enter URL',
                        getVisibility() {
                            return this.model.get('makeLink');
                        }
                    },
                    {
                        type: 'select',
                        label: 'Link to Page',
                        name: 'linkToPage',
                        options: [
                            { id: '', name: '-- Select a page --' },
                            ...stages
                                .filter(stage => stage.id !== stageId)
                                .map(stage => ({
                                    id: stage.id,
                                    name: `${stage.name} (${stage.type})`
                                }))
                        ],
                        getVisibility() {
                            return this.model.get('makeLink');
                        }
                    },
                    {
                        type: 'select',
                        label: 'Link to Element',
                        name: 'linkToElement',
                        options: getPageElements(),
                        getVisibility() {
                            return this.model.get('makeLink');
                        }
                    },
                    {
                        type: 'checkbox',
                        label: 'Open in new tab',
                        name: 'newTab',
                        getVisibility() {
                            return this.model.get('makeLink');
                        }
                    }
                ]
            },
            
            init() {
                this.on('change:makeLink', this.handleMakeLink);
                this.on('change:linkUrl', this.handleLinkUrl);
                this.on('change:linkToPage', this.handleLinkToPage);
                this.on('change:linkToElement', this.handleLinkToElement);
                this.on('change:newTab', this.handleNewTab);
                this.on('change:content', this.handleContent);
            },
            
            // ... rest of the button component methods ...
        }
    });

    // Refresh element options when page changes
    editor.on('page', () => {
        const linkType = editor.DomComponents.getType('link');
        if (linkType) {
            linkType.model.prototype.defaults.traits.find(
                t => t.name === 'anchorLink'
            ).options = getPageElements();
        }
        
        const buttonType = editor.DomComponents.getType('button');
        if (buttonType) {
            buttonType.model.prototype.defaults.traits.find(
                t => t.name === 'linkToElement'
            ).options = getPageElements();
        }
    });
    
        // Add the original direct form component
        editor.BlockManager.add('direct-form', {
            label: 'Direct Form',
            category: 'Forms',
            content: `
            <div class="bss-direct-form-container" data-redirect-page="${selectedRedirectPage || ''}">
                <div class="bss-form-content">
                    <div class="bss-form-header">
                        <h3>Join Our Community</h3>
                        <p>Get exclusive updates and offers</p>
                    </div>
                    
                    <form class="bss-direct-form" data-redirect-page="${selectedRedirectPage || ''}" data-redirect-set="true">
                        <div class="form-group">
                            <input type="text" name="name" placeholder="Your Name" required>
                        </div>
                        <div class="form-group">
                            <input type="email" name="email" placeholder="Your Email" required>
                        </div>
                        <div class="form-group">
                            <input type="tel" name="phone" placeholder="Phone Number" required>
                        </div>
                        <div class="form-group">
                            <input type="text" name="city" placeholder="Your City" required>
                        </div>
                        <div class="form-group">
                            <input type="text" name="country" placeholder="Your Country" required>
                        </div>
                        <button type="submit" class="bss-submit-btn">
                            <i class="fas fa-paper-plane"></i> SEND
                        </button>
                    </form>
                    
                    <div class="form-message" style="display:none; margin-top:15px;"></div>
                    
                    <div class="bss-form-footer">
                        <p>We respect your privacy. Unsubscribe at any time.</p>
                    </div>
                </div>
                
                <style>
                    .bss-direct-form-container { 
                        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                        max-width: 500px;
                        margin: 20px auto;
                        padding: 0;
                    }
                    .bss-form-content {
                        background-color: #fff;
                        padding: 30px;
                        border-radius: 12px;
                        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
                        border: 1px solid #e1e8ed;
                    }
                    .bss-form-header {
                        text-align: center;
                        margin-bottom: 25px;
                    }
                    .bss-form-header h3 {
                        color: #2c3e50;
                        margin: 0 0 10px 0;
                        font-size: 24px;
                        font-weight: 600;
                    }
                    .bss-form-header p {
                        color: #7f8c8d;
                        font-size: 16px;
                        margin: 0;
                        line-height: 1.5;
                    }
                    .form-group { 
                        margin-bottom: 20px; 
                    }
                    .form-group input {
                        width: 100%;
                        padding: 15px;
                        border: 2px solid #e1e8ed;
                        border-radius: 8px;
                        font-size: 16px;
                        box-sizing: border-box;
                        transition: all 0.3s ease;
                        background-color: #f8f9fa;
                    }
                    .form-group input:focus {
                        outline: none;
                        border-color: #4CAF50;
                        background-color: #fff;
                        box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
                    }
                    .form-group input:hover {
                        border-color: #bdc3c7;
                        background-color: #fff;
                    }
                    .bss-submit-btn {
                        width: 100%;
                        padding: 15px;
                        background: linear-gradient(135deg, #4CAF50, #45a049);
                        color: white;
                        border: none;
                        border-radius: 8px;
                        font-size: 18px;
                        font-weight: 600;
                        cursor: pointer;
                        transition: all 0.3s ease;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        gap: 10px;
                        text-transform: uppercase;
                        letter-spacing: 0.5px;
                    }
                    .bss-submit-btn:hover { 
                        background: linear-gradient(135deg, #45a049, #4CAF50);
                        transform: translateY(-2px);
                        box-shadow: 0 8px 20px rgba(76, 175, 80, 0.3);
                    }
                    .bss-submit-btn:active {
                        transform: translateY(0);
                    }
                    .bss-submit-btn:disabled {
                        background: #bdc3c7;
                        cursor: not-allowed;
                        transform: none;
                        box-shadow: none;
                    }
                    .form-message {
                        padding: 15px;
                        border-radius: 8px;
                        text-align: center;
                        font-size: 16px;
                        font-weight: 500;
                    }
                    .form-message.success {
                        background-color: #d4edda;
                        color: #155724;
                        border: 1px solid #c3e6cb;
                    }
                    .form-message.error {
                        background-color: #f8d7da;
                        color: #721c24;
                        border: 1px solid #f5c6cb;
                    }
                    .bss-form-footer {
                        margin-top: 25px;
                        text-align: center;
                        padding-top: 20px;
                        border-top: 1px solid #e1e8ed;
                    }
                    .bss-form-footer p {
                        font-size: 14px;
                        color: #95a5a6;
                        margin: 0;
                        line-height: 1.4;
                    }
                    
                    @media (max-width: 600px) {
                        .bss-direct-form-container {
                            margin: 10px;
                            max-width: none;
                        }
                        .bss-form-content {
                            padding: 20px;
                        }
                        .bss-form-header h3 {
                            font-size: 20px;
                        }
                        .bss-form-header p {
                            font-size: 14px;
                        }
                        .form-group input {
                            padding: 12px;
                            font-size: 16px;
                        }
                        .bss-submit-btn {
                            padding: 12px;
                            font-size: 16px;
                        }
                    }
                    
                    @keyframes spin {
                        0% { transform: rotate(0deg); }
                        100% { transform: rotate(360deg); }
                    }
                    .fa-spin {
                        animation: spin 1s linear infinite;
                    }
                </style>
            `,
            attributes: { class: 'bss-direct-form-element' },
            media: `<svg viewBox="0 0 24 24"><path fill="currentColor" d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg>`,
        });

        // Add the new Direct Form V2 with professional design
        editor.BlockManager.add('direct-form-v2', {
            label: 'Direct Form V2',
            category: 'Forms',
            content: `
            <div class="bss-direct-form-v2-container" data-redirect-page="${selectedRedirectPage || ''}">
                <div class="bss-form-v2-content">
                    <div class="bss-form-v2-header">
                        <div class="header-icon">
                            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M20 4H4C2.9 4 2 4.9 2 6V18C2 19.1 2.9 20 4 20H20C21.1 20 22 19.1 22 18V6C22 4.9 21.1 4 20 4ZM20 8L12 13L4 8V6L12 11L20 6V8Z" fill="#2563eb"/>
                            </svg>
                        </div>
                        <h3>Professional Contact</h3>
                        <p>Connect with us for personalized solutions</p>
                    </div>
                    
                    <form class="bss-direct-form-v2" data-redirect-page="${selectedRedirectPage || ''}" data-redirect-set="true">
                        <div class="form-row">
                            <div class="form-group-v2">
                                <label for="name-v2">Full Name *</label>
                                <div class="input-wrapper">
                                    <svg class="input-icon" width="16" height="16" viewBox="0 0 24 24" fill="none">
                                        <path d="M12 12C14.21 12 16 10.21 16 8C16 5.79 14.21 4 12 4C9.79 4 8 5.79 8 8C8 10.21 9.79 12 12 12ZM12 14C9.33 14 4 15.34 4 18V20H20V18C20 15.34 14.67 14 12 14Z" fill="#6b7280"/>
                                    </svg>
                                    <input type="text" id="name-v2" name="name" placeholder="Enter your full name" required>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group-v2">
                                <label for="email-v2">Email Address *</label>
                                <div class="input-wrapper">
                                    <svg class="input-icon" width="16" height="16" viewBox="0 0 24 24" fill="none">
                                        <path d="M20 4H4C2.9 4 2 4.9 2 6V18C2 19.1 2.9 20 4 20H20C21.1 20 22 19.1 22 18V6C22 4.9 21.1 4 20 4ZM20 8L12 13L4 8V6L12 11L20 6V8Z" fill="#6b7280"/>
                                    </svg>
                                    <input type="email" id="email-v2" name="email" placeholder="your.email@example.com" required>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group-v2">
                                <label for="phone-v2">Phone Number *</label>
                                <div class="input-wrapper">
                                    <svg class="input-icon" width="16" height="16" viewBox="0 0 24 24" fill="none">
                                        <path d="M6.62 10.79C8.06 13.62 10.38 15.94 13.21 17.38L15.41 15.18C15.69 14.9 16.08 14.82 16.43 14.93C17.55 15.3 18.75 15.5 20 15.5C20.55 15.5 21 15.95 21 16.5V20C21 20.55 20.55 21 20 21C10.61 21 3 13.39 3 4C3 3.45 3.45 3 4 3H7.5C8.05 3 8.5 3.45 8.5 4C8.5 5.25 8.7 6.45 9.07 7.57C9.18 7.92 9.1 8.31 8.82 8.59L6.62 10.79Z" fill="#6b7280"/>
                                    </svg>
                                    <input type="tel" id="phone-v2" name="phone" placeholder="+1 (555) 123-4567" required>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-row-split">
                            <div class="form-group-v2 half-width">
                                <label for="city-v2">City *</label>
                                <div class="input-wrapper">
                                    <svg class="input-icon" width="16" height="16" viewBox="0 0 24 24" fill="none">
                                        <path d="M12 2C8.13 2 5 5.13 5 9C5 14.25 12 22 12 22S19 14.25 19 9C19 5.13 15.87 2 12 2ZM12 11.5C10.62 11.5 9.5 10.38 9.5 9S10.62 6.5 12 6.5S14.5 7.62 14.5 9S13.38 11.5 12 11.5Z" fill="#6b7280"/>
                                    </svg>
                                    <input type="text" id="city-v2" name="city" placeholder="Your city" required>
                                </div>
                            </div>
                            
                            <div class="form-group-v2 half-width">
                                <label for="country-v2">Country *</label>
                                <div class="input-wrapper">
                                    <svg class="input-icon" width="16" height="16" viewBox="0 0 24 24" fill="none">
                                        <path d="M12 2C6.48 2 2 6.48 2 12S6.48 22 12 22S22 17.52 22 12S17.52 2 12 2ZM11 19.93C7.05 19.44 4 16.08 4 12C4 11.38 4.08 10.79 4.21 10.21L9 15V16C9 17.1 9.9 18 11 18V19.93ZM17.9 17.39C17.64 16.58 16.9 16 16 16H15V13C15 12.45 14.55 12 14 12H8V10H10C10.55 10 11 9.55 11 9V7H13C14.1 7 15 6.1 15 5V4.59C17.93 5.78 20 8.65 20 12C20 14.08 19.2 15.97 17.9 17.39Z" fill="#6b7280"/>
                                    </svg>
                                    <input type="text" id="country-v2" name="country" placeholder="Your country" required>
                                </div>
                            </div>
                        </div>
                        
                        <button type="submit" class="bss-submit-btn-v2">
                            <span class="btn-text">Get Started</span>
                            <svg class="btn-arrow" width="20" height="20" viewBox="0 0 24 24" fill="none">
                                <path d="M5 12H19M19 12L12 5M19 12L12 19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </button>
                    </form>
                    
                    <div class="form-message" style="display:none; margin-top:20px;"></div>
                    
                    <div class="bss-form-v2-footer">
                        <div class="security-badge">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                                <path d="M12 1L3 5V11C3 16.55 6.84 21.74 12 23C17.16 21.74 21 16.55 21 11V5L12 1ZM10 17L6 13L7.41 11.59L10 14.17L16.59 7.58L18 9L10 17Z" fill="#10b981"/>
                            </svg>
                            <span>100% Secure & Confidential</span>
                        </div>
                    </div>
                </div>
                
                <style>
                    .bss-direct-form-v2-container { 
                        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                        max-width: 600px;
                        margin: 30px auto;
                        padding: 0;
                    }
                    
                    .bss-form-v2-content {
                        background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
                        padding: 40px;
                        border-radius: 20px;
                        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.12), 0 8px 25px rgba(0, 0, 0, 0.08);
                        border: 1px solid rgba(148, 163, 184, 0.1);
                        position: relative;
                        overflow: hidden;
                    }
                    
                    .bss-form-v2-content::before {
                        content: '';
                        position: absolute;
                        top: 0;
                        left: 0;
                        right: 0;
                        height: 4px;
                        background: linear-gradient(90deg, #2563eb, #3b82f6, #1d4ed8);
                    }
                    
                    .bss-form-v2-header {
                        text-align: center;
                        margin-bottom: 35px;
                    }
                    
                    .header-icon {
                        width: 60px;
                        height: 60px;
                        background: linear-gradient(135deg, #dbeafe, #bfdbfe);
                        border-radius: 16px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        margin: 0 auto 20px;
                        box-shadow: 0 8px 20px rgba(37, 99, 235, 0.15);
                    }
                    
                    .bss-form-v2-header h3 {
                        color: #1e293b;
                        margin: 0 0 8px 0;
                        font-size: 28px;
                        font-weight: 700;
                        letter-spacing: -0.5px;
                    }
                    
                    .bss-form-v2-header p {
                        color: #64748b;
                        font-size: 16px;
                        margin: 0;
                        line-height: 1.6;
                        font-weight: 400;
                    }
                    
                    .form-row {
                        margin-bottom: 24px;
                    }
                    
                    .form-row-split {
                        display: flex;
                        gap: 16px;
                        margin-bottom: 24px;
                    }
                    
                    .form-group-v2 {
                        display: flex;
                        flex-direction: column;
                    }
                    
                    .form-group-v2.half-width {
                        flex: 1;
                    }
                    
                    .form-group-v2 label {
                        color: #374151;
                        font-size: 14px;
                        font-weight: 600;
                        margin-bottom: 8px;
                        display: block;
                    }
                    
                    .input-wrapper {
                        position: relative;
                    }
                    
                    .input-icon {
                        position: absolute;
                        left: 16px;
                        top: 50%;
                        transform: translateY(-50%);
                        z-index: 2;
                    }
                    
                    .form-group-v2 input {
                        width: 100%;
                        padding: 16px 16px 16px 48px;
                        border: 2px solid #e5e7eb;
                        border-radius: 12px;
                        font-size: 16px;
                        font-weight: 400;
                        box-sizing: border-box;
                        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                        background-color: #ffffff;
                        color: #1f2937;
                    }
                    
                    .form-group-v2 input::placeholder {
                        color: #9ca3af;
                    }
                    
                    .form-group-v2 input:focus {
                        outline: none;
                        border-color: #2563eb;
                        background-color: #ffffff;
                        box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
                        transform: translateY(-1px);
                    }
                    
                    .form-group-v2 input:hover:not(:focus) {
                        border-color: #d1d5db;
                        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
                    }
                    
                    .bss-submit-btn-v2 {
                        width: 100%;
                        padding: 18px 24px;
                        background: linear-gradient(135deg, #2563eb, #1d4ed8);
                        color: white;
                        border: none;
                        border-radius: 12px;
                        font-size: 16px;
                        font-weight: 600;
                        cursor: pointer;
                        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        gap: 12px;
                        margin-top: 8px;
                        position: relative;
                        overflow: hidden;
                    }
                    
                    .bss-submit-btn-v2::before {
                        content: '';
                        position: absolute;
                        top: 0;
                        left: -100%;
                        width: 100%;
                        height: 100%;
                        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
                        transition: left 0.5s;
                    }
                    
                    .bss-submit-btn-v2:hover::before {
                        left: 100%;
                    }
                    
                    .bss-submit-btn-v2:hover { 
                        background: linear-gradient(135deg, #1d4ed8, #1e40af);
                        transform: translateY(-2px);
                        box-shadow: 0 12px 35px rgba(37, 99, 235, 0.4);
                    }
                    
                    .bss-submit-btn-v2:active {
                        transform: translateY(0);
                        box-shadow: 0 6px 20px rgba(37, 99, 235, 0.3);
                    }
                    
                    .bss-submit-btn-v2:disabled {
                        background: linear-gradient(135deg, #9ca3af, #6b7280);
                        cursor: not-allowed;
                        transform: none;
                        box-shadow: none;
                    }
                    
                    .btn-arrow {
                        transition: transform 0.3s ease;
                    }
                    
                    .bss-submit-btn-v2:hover .btn-arrow {
                        transform: translateX(4px);
                    }
                    
                    .form-message {
                        padding: 16px 20px;
                        border-radius: 12px;
                        text-align: center;
                        font-size: 15px;
                        font-weight: 500;
                        border: 1px solid;
                    }
                    
                    .form-message.success {
                        background-color: #ecfdf5;
                        color: #047857;
                        border-color: #a7f3d0;
                    }
                    
                    .form-message.error {
                        background-color: #fef2f2;
                        color: #dc2626;
                        border-color: #fca5a5;
                    }
                    
                    .bss-form-v2-footer {
                        margin-top: 30px;
                        text-align: center;
                    }
                    
                    .security-badge {
                        display: inline-flex;
                        align-items: center;
                        gap: 8px;
                        color: #059669;
                        font-size: 14px;
                        font-weight: 500;
                        background-color: #ecfdf5;
                        padding: 8px 16px;
                        border-radius: 20px;
                        border: 1px solid #a7f3d0;
                    }
                    
                    @media (max-width: 640px) {
                        .bss-direct-form-v2-container {
                            margin: 20px 15px;
                            max-width: none;
                        }
                        
                        .bss-form-v2-content {
                            padding: 30px 24px;
                        }
                        
                        .bss-form-v2-header h3 {
                            font-size: 24px;
                        }
                        
                        .bss-form-v2-header p {
                            font-size: 15px;
                        }
                        
                        .form-row-split {
                            flex-direction: column;
                            gap: 24px;
                        }
                        
                        .form-group-v2 input {
                            padding: 14px 14px 14px 44px;
                            font-size: 16px;
                        }
                        
                        .bss-submit-btn-v2 {
                            padding: 16px 20px;
                            font-size: 15px;
                        }
                        
                        .input-icon {
                            left: 14px;
                            width: 14px;
                            height: 14px;
                        }
                    }
                    
                    @keyframes pulse {
                        0%, 100% { opacity: 1; }
                        50% { opacity: 0.5; }
                    }
                    
                    .bss-submit-btn-v2:disabled .btn-text {
                        animation: pulse 1.5s ease-in-out infinite;
                    }
                </style>
            `,
            attributes: { class: 'bss-direct-form-v2-element' },
            media: `<svg viewBox="0 0 24 24"><path fill="currentColor" d="M20 4H4C2.9 4 2 4.9 2 6V18C2 19.1 2.9 20 4 20H20C21.1 20 22 19.1 22 18V6C22 4.9 21.1 4 20 4ZM20 18H4V8L12 13L20 8V18ZM20 6L12 11L4 6V6H20V6Z"/></svg>`,
        });

        // Modified PDF Download Form - Direct form with only email and name fields
        // Replace the existing PDF Download block with this updated version
editor.BlockManager.add('pdf-download', {
    label: 'PDF Download',
    category: 'Forms',
    content: `
    <div class="pdf-form-container">
        <div class="pdf-form-content">
            <div class="pdf-form-header">
                <h3>Get Your Free E-book</h3>
                <p>Enter your details to download the PDF</p>
            </div>
            
            <form class="pdf-download-form">
                <div class="pdf-form-group">
                    <input type="email" name="email" placeholder="Your best email" required>
                </div>
                
                <div class="pdf-form-group">
                    <input type="text" name="name" placeholder="Your name" required>
                </div>
                
                <button type="submit" class="pdf-download-btn">
                    <span>Download Now</span>
                </button>
            </form>
            
            <div class="pdf-form-message" style="display:none; margin-top:15px;"></div>
            
            <div class="pdf-form-footer">
                <p>We respect your privacy. Unsubscribe at any time.</p>
            </div>
        </div>
        
        <script>
            (function() {
                function initPDFForm() {
                    const pdfForms = document.querySelectorAll('.pdf-download-form:not([data-initialized])');
                    
                    pdfForms.forEach(form => {
                        form.setAttribute('data-initialized', 'true');
                        
                        const container = form.closest('.pdf-form-container');
                        const messageEl = container ? container.querySelector('.pdf-form-message') : null;
                        const submitBtn = form.querySelector('.pdf-download-btn');
                        
                        const showMessage = (message, type) => {
                            if (messageEl) {
                                messageEl.style.display = 'block';
                                messageEl.className = 'pdf-form-message ' + type;
                                messageEl.textContent = message;
                                messageEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            } else {
                                alert(message);
                            }
                        };

                        const hideMessage = () => {
                            if (messageEl) {
                                messageEl.style.display = 'none';
                                messageEl.textContent = '';
                            }
                        };
                        
                        // Hide message when user starts typing
                        form.querySelectorAll('input').forEach(input => {
                            input.addEventListener('focus', hideMessage);
                        });
                        
                        // Form submission
                        form.addEventListener('submit', function(e) {
                            e.preventDefault();
                            
                            if (!submitBtn) return;
                            
                            const originalText = submitBtn.innerHTML;
                            submitBtn.innerHTML = '<span>Processing...</span>';
                            submitBtn.disabled = true;
                            hideMessage();
                            
                            const formData = {
                                email: this.querySelector('input[name="email"]').value,
                                name: this.querySelector('input[name="name"]').value
                            };
                            
                            // Console log the form data
                            console.log('=== PDF DOWNLOAD FORM SUBMISSION ===');
                            console.log('ðŸ“§ Email:', formData.email);
                            console.log('ðŸ‘¤ Name:', formData.name);
                            console.log('â° Timestamp:', new Date().toLocaleString());
                            console.log('=====================================');
                            
                            // Simulate processing
                            setTimeout(() => {
                                showMessage('ðŸŽ‰ Thank you! Your PDF download link has been sent to your email!', 'success');
                                
                                // Reset form after success
                                setTimeout(() => {
                                    this.reset();
                                }, 3000);
                                
                                // Reset button
                                submitBtn.innerHTML = originalText;
                                submitBtn.disabled = false;
                            }, 2000);
                        });
                    });
                }
                
                // Initialize when DOM is ready
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', initPDFForm);
                } else {
                    initPDFForm();
                }
                
                // Also initialize after a delay to catch dynamically added forms
                setTimeout(initPDFForm, 1000);
            })();
        </script>
        
        <style>
            .pdf-form-container {
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                max-width: 500px;
                margin: 20px auto;
                padding: 0;
            }
            
            .pdf-form-content {
                background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
                padding: 35px;
                border-radius: 16px;
                box-shadow: 0 15px 40px rgba(0, 0, 0, 0.1), 0 5px 20px rgba(0, 0, 0, 0.05);
                border: 1px solid rgba(231, 76, 60, 0.1);
                position: relative;
                overflow: hidden;
            }
            
            .pdf-form-content::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                height: 4px;
                background: linear-gradient(90deg, #e74c3c, #c0392b, #a93226);
            }
            
            .pdf-form-header {
                text-align: center;
                margin-bottom: 30px;
            }
            
            .pdf-form-header h3 {
                color: #2c3e50;
                margin: 0 0 10px 0;
                font-size: 26px;
                font-weight: 700;
                letter-spacing: -0.5px;
            }
            
            .pdf-form-header p {
                color: #7f8c8d;
                margin: 0;
                font-size: 16px;
                line-height: 1.5;
            }
            
            .pdf-form-group {
                margin-bottom: 20px;
            }
            
            .pdf-form-group input {
                width: 100%;
                padding: 16px 20px;
                border: 2px solid #e1e8ed;
                border-radius: 12px;
                font-size: 16px;
                box-sizing: border-box;
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                background-color: #f8f9fa;
                color: #2c3e50;
            }
            
            .pdf-form-group input::placeholder {
                color: #95a5a6;
            }
            
            .pdf-form-group input:focus {
                outline: none;
                border-color: #e74c3c;
                background-color: #fff;
                box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.1);
                transform: translateY(-2px);
            }
            
            .pdf-form-group input:hover:not(:focus) {
                border-color: #bdc3c7;
                background-color: #fff;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            }
            
            .pdf-download-btn {
                width: 100%;
                padding: 18px 24px;
                background: linear-gradient(135deg, #e74c3c, #c0392b);
                color: white;
                border: none;
                border-radius: 12px;
                font-size: 18px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                text-transform: uppercase;
                letter-spacing: 0.5px;
                margin-top: 10px;
                position: relative;
                overflow: hidden;
            }
            
            .pdf-download-btn::before {
                content: '';
                position: absolute;
                top: 0;
                left: -100%;
                width: 100%;
                height: 100%;
                background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
                transition: left 0.5s;
            }
            
            .pdf-download-btn:hover::before {
                left: 100%;
            }
            
            .pdf-download-btn:hover {
                background: linear-gradient(135deg, #c0392b, #a93226);
                transform: translateY(-3px);
                box-shadow: 0 12px 35px rgba(231, 76, 60, 0.4);
            }
            
            .pdf-download-btn:active {
                transform: translateY(-1px);
                box-shadow: 0 6px 20px rgba(231, 76, 60, 0.3);
            }
            
            .pdf-download-btn:disabled {
                background: linear-gradient(135deg, #bdc3c7, #95a5a6);
                cursor: not-allowed;
                transform: none;
                box-shadow: none;
            }
            
            .pdf-form-message {
                padding: 15px 20px;
                border-radius: 10px;
                text-align: center;
                font-size: 15px;
                font-weight: 500;
                border: 1px solid;
            }
            
            .pdf-form-message.success {
                background-color: #d4edda;
                color: #155724;
                border-color: #c3e6cb;
            }
            
            .pdf-form-message.error {
                background-color: #f8d7da;
                color: #721c24;
                border-color: #f5c6cb;
            }
            
            .pdf-form-footer {
                text-align: center;
                margin-top: 25px;
                padding-top: 20px;
                border-top: 1px solid #ecf0f1;
            }
            
            .pdf-form-footer p {
                font-size: 14px;
                color: #95a5a6;
                margin: 0;
                line-height: 1.4;
            }
            
            @media (max-width: 600px) {
                .pdf-form-container {
                    margin: 10px;
                    max-width: none;
                }
                
                .pdf-form-content {
                    padding: 25px 20px;
                }
                
                .pdf-form-header h3 {
                    font-size: 22px;
                }
                
                .pdf-form-header p {
                    font-size: 14px;
                }
                
                .pdf-form-group input {
                    padding: 14px 18px;
                    font-size: 16px;
                }
                
                .pdf-download-btn {
                    padding: 16px 20px;
                    font-size: 16px;
                }
            }
            
            @keyframes pulse {
                0%, 100% { opacity: 1; }
                50% { opacity: 0.5; }
            }
            
            .pdf-download-btn:disabled span {
                animation: pulse 1.5s ease-in-out infinite;
            }
        </style>
    </div>
    `,
    attributes: { class: 'pdf-download-element' },
    media: `<svg viewBox="0 0 24 24"><path fill="currentColor" d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/></svg>`,
});

        addLandingPageComponents(editor, user?.name || 'guest');
        
        // Initialize form handlers
        initializeDirectFormHandlers();
        
        const pagesEl = document.querySelector("#pages");
        if (pagesEl) {
            editor.Pages.__appendTo({ el: pagesEl });
        }
        
        setTimeout(() => {
            const pageToSelect = editor.Pages.get(stageId);
            if (pageToSelect) {
                editor.Pages.select(pageToSelect);
                editor.runCommand('canvas:reload');
            } else if (editor.Pages.getAll().length > 0) {
                editor.Pages.select(editor.Pages.getAll()[0]);
                editor.runCommand('canvas:reload');
            }
            
            if (selectedRedirectPage) {
                updateDirectFormsRedirect(editor, selectedRedirectPage);
            }
        }, 500);
    }, [selectedRedirectPage, stages, stageId, slug, user, funnelId]);

    useEffect(() => {
        return () => {
            if (editorInstance) {
                editorInstance.destroy();
                setEditorInstance(null);
                delete window.editor;
            }
        };
    }, [editorInstance]);

    useEffect(() => {
        const handleBeforeUnload = (event) => {
            event.preventDefault();
            event.returnValue = 'Really want to exit? Unsaved changes may be lost.';
        };

        window.addEventListener('beforeunload', handleBeforeUnload);

        return () => {
            window.removeEventListener('beforeunload', handleBeforeUnload);
        };
    }, []);

    const generateInitialProject = useCallback(() => {
        const savedProjectData = contentData.projectData;
        const hasSavedPages = savedProjectData && savedProjectData.pages && Array.isArray(savedProjectData.pages) && savedProjectData.pages.length > 0;
    
        const createPageFromTemplate = (stage) => {
            const isCustom = stage.type === 'custom-page';
            const config = isCustom
                ? contentData.customStagesConfig?.[stage.id]
                : contentData.stagesConfig?.[stage.type];
            const templateSet = {
                'welcome-page': templates.welcomeTemplates, 'vsl-page': templates.vslTemplates,
                'thankyou-page': templates.thankyouTemplates, 'whatsapp-page': templates.whatsappTemplates,
                'product-offer': templates.productOfferTemplates, 'custom-page': templates.miscTemplates,
                'appointment-page': templates.appointmentTemplates, 'payment-page': templates.paymentTemplates,
            }[stage.type];
            const templateKey = config?.selectedTemplateKey;
            let template = (templateKey && templateSet && templateSet[templateKey]) 
                            ? templateSet[templateKey] 
                            : (templateSet ? Object.values(templateSet)[0] : null);
    
            if (!template) {
                 return {
                    id: stage.id,
                    name: stage.name,
                    component: `<h1>${stage.name}</h1><p>Template not configured for this stage type.</p>`,
                    styles: '', 
                    script: '',
                    basicInfo: config?.basicInfo || {},
                    redirectPage: config?.redirectPage || ''
                };
            }
    
           return {
            id: stage.id,
            name: stage.name,
            component: template.html || `<h1>${stage.name}</h1><p>Template content not found.</p>`,
            styles: template.css || '',
            script: typeof template.js === 'function' ? template.js.toString() : template.js || '',
            basicInfo: config?.basicInfo || {},
            redirectPage: config?.redirectPage || ''
        };
    };

    let pages;
    let globalCss = '';

    if (hasSavedPages) {
        globalCss = savedProjectData.globalCss || '';
        pages = stages.map(stage => {
            const savedPage = savedProjectData.pages.find(p => p.id === stage.id);
            return savedPage ? {
                id: stage.id,
                name: savedPage.name || stage.name,
                component: savedPage.html,
                styles: savedPage.css || '',
                script: savedPage.js || '',
                basicInfo: savedPage.basicInfo || {},
                redirectPage: savedPage.redirectPage || ''
            } : createPageFromTemplate(stage);
        });
    } else {
        pages = stages.map(stage => createPageFromTemplate(stage));
    }

    return { pages, css: globalCss };
}, [stages, contentData, stageId]);

    const applyDataToPage = (page, { html, css, js, basicInfo, redirectPage }) => {
        if (!editorInstance || !page) return;
        try {
            if (html !== undefined) {
                page.set('component', '');
                page.set('component', html);
            }
            if (css !== undefined) {
                page.set('styles', css);
                const cssRules = editorInstance.CssComposer.getAll();
                const pageRules = cssRules.filter(rule => true);
                pageRules.forEach(rule => editorInstance.CssComposer.remove(rule));
                if (css.trim()) {
                    editorInstance.CssComposer.setRule(css);
                }
            }
            if (js !== undefined) {
                page.set('script', typeof js === 'function' ? js.toString() : js);
            }
            if (basicInfo) {
                page.set('basicInfo', basicInfo);
            }
            if (redirectPage !== undefined) {
                page.set('redirectPage', redirectPage);
                setSelectedRedirectPage(redirectPage);
                updateDirectFormsRedirect(editorInstance, redirectPage);
            }
            editorInstance.Pages.select(page);
            editorInstance.trigger('change:canvas');
            editorInstance.runCommand('canvas:reload');
        } catch (error) {
            console.error(`Error applying data to page ${page.id}:`, error);
        }
    };

    const extractContentForAI = (editor) => {
        const content = [];
        const page = editor.Pages.getSelected();
        if (!page) return content;
        const walkComponents = (component) => {
            if (!component || !component.view || !component.view.el) return;
            if (component.is('text') && component.toHTML().trim().length > 0) {
                content.push({ id: component.cid, type: 'text', content: component.toHTML() });
            } else if (component.is('image')) {
                content.push({ id: component.cid, type: 'image', src: component.get('src') });
            }
            component.components().forEach(walkComponents);
        };
        walkComponents(page.getMainComponent());
        return content;
    };

    const applyAIUpdates = (editor, updatedData) => {
        if (!editor || !updatedData) return;
        const currentPage = editor.Pages.getSelected();
        if (!currentPage) return;

        updatedData.forEach(item => {
            const component = currentPage.getMainComponent().find(`#${item.id}`)[0];
            if (component) {
                if (item.type === 'text' && item.content !== undefined) {
                    component.components(item.content);
                } else if (item.type === 'image' && item.src !== undefined) {
                    component.set('src', item.src);
                }
            }
        });
        editor.trigger('change:canvas');
        editor.runCommand('canvas:reload');
    };

    const handleAssetUpload = async (files, onResponse) => {
        const formData = new FormData();
        for (let i = 0; i < files.length; i++) {
            formData.append('assets', files[i]);
        }
        try {
            const response = await fetch(`${API_BASE_URL}/api/assets`, {
                method: 'POST',
                body: formData,
            });
            if (!response.ok) {
                const errData = await response.json();
                throw new Error(errData.error || 'Upload failed');
            }
            const result = await response.json();
            onResponse(result.data);
            setAssets(prevAssets => [...result.data, ...prevAssets]);
        } catch (error) {
            console.error('Upload error:', error);
            alert(`Failed to upload files: ${error.message}`);
            onResponse([]);
        }
    };

    const extractPageCSS = (editor, pageId) => {
        try {
            const cssComposer = editor.CssComposer;
            const allRules = cssComposer.getAll();
            let pageCSS = '';
            
            allRules.forEach(rule => {
                const selector = rule.get('selectors');
                const cssText = rule.toCSS();
                if (cssText && cssText.trim()) {
                    pageCSS += cssText + '\n';
                }
            });
            
            return pageCSS.trim();
        } catch (error) {
            console.error('Error extracting page CSS:', error);
            return '';
        }
    };

    const handleSave = async (saveType) => {
        if (!editorInstance) {
            alert("Editor is not ready.");
            return;
        }

        const editor = editorInstance;
        const globalCss = editor.getCss();
        const funnelName = contentData?.name || 'My Funnel';

        const preparePageData = (page) => {
            const stage = stages.find(s => s.id === page.id);
            const pageCSS = extractPageCSS(editor, page.id);
            const pageHTML = page.getMainComponent().toHTML();
            
            // Add the form initialization script to pages that contain forms (updated for both form types)
            const hasDirectForm = pageHTML.includes('bss-direct-form') || pageHTML.includes('bss-direct-form-v2');
            let finalHTML = pageHTML;
            
            if (hasDirectForm) {
                const formScript = `
                <script>
                (function() {
                    const initForms = () => {
                        const forms = document.querySelectorAll('.bss-direct-form:not([data-initialized]), .bss-direct-form-v2:not([data-initialized])');
                        forms.forEach(form => {
                            form.setAttribute('data-initialized', 'true');
                            const container = form.closest('.bss-direct-form-container, .bss-direct-form-v2-container');
                            const messageEl = container ? container.querySelector('.form-message') : null;
                            const submitBtn = form.querySelector('.bss-submit-btn, .bss-submit-btn-v2');
                            
                            const showMessage = (message, type) => {
                                if (messageEl) {
                                    messageEl.style.display = 'block';
                                    messageEl.className = 'form-message ' + type;
                                    messageEl.textContent = message;
                                } else {
                                    alert(message);
                                }
                            };

                            const hideMessage = () => {
                                if (messageEl) {
                                    messageEl.style.display = 'none';
                                    messageEl.textContent = '';
                                }
                            };
                            
                            form.querySelectorAll('input').forEach(input => {
                                input.addEventListener('focus', hideMessage);
                            });
                            
                            form.addEventListener('submit', async function(e) {
                                e.preventDefault();
                                const originalText = submitBtn.innerHTML;
                                submitBtn.innerHTML = '<span>Processing...</span>';
                                submitBtn.disabled = true;
                                hideMessage();
                                
                                const redirectPage = this.getAttribute('data-redirect-page') || container.getAttribute('data-redirect-page');
                                
                                try {
                                    const formData = {
                                        name: this.querySelector('input[name="name"]').value,
                                        email: this.querySelector('input[name="email"]').value,
                                        phone: this.querySelector('input[name="phone"]').value,
                                        city: this.querySelector('input[name="city"]').value,
                                        country: this.querySelector('input[name="country"]').value,
                                        coachId: '${user?.id}',
                                        funnelId: '${funnelId || 'default-funnel-id'}'
                                    };
                                    
                                    console.log('Form submitted:', formData);
                                    
                                    const response = await fetch('https://api.funnelseye.com/api/leads', {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/json'
                                        },
                                        body: JSON.stringify(formData)
                                    });
                                    
                                    const result = await response.json();
                                    
                                    if (result.success) {
                                        showMessage('Thank you! Your submission was successful!', 'success');
                                        
                                        if (redirectPage && redirectPage.trim()) {
                                            setTimeout(() => {
                                                let redirectUrl;
                                                if (redirectPage.startsWith('http')) {
                                                    redirectUrl = redirectPage;
                                                } else if (redirectPage.startsWith('/')) {
                                                    redirectUrl = redirectPage;
                                                } else {
                                                    const pathParts = window.location.pathname.split('/').filter(Boolean);
                                                    const funnelSlug = pathParts.length >= 2 ? pathParts[1] : 'funnel';
                                                    redirectUrl = '/funnels/' + funnelSlug + '/' + redirectPage;
                                                }
                                                console.log('Redirecting to:', redirectUrl);
                                                window.location.href = redirectUrl;
                                            }, 2000);
                                        }
                                        
                                        setTimeout(() => this.reset(), 3000);
                                    } else {
                                        throw new Error(result.message || 'Failed to submit form');
                                    }
                                    
                                } catch (error) {
                                    console.error('Error:', error);
                                    showMessage('Sorry, there was an error. Please try again.', 'error');
                                } finally {
                                    setTimeout(() => {
                                        submitBtn.innerHTML = originalText;
                                        submitBtn.disabled = false;
                                    }, 1000);
                                }
                            });
                        });
                    };
                    
                    if (document.readyState === 'loading') {
                        document.addEventListener('DOMContentLoaded', initForms);
                    } else {
                        initForms();
                    }
                })();
                </script>`;
                
                finalHTML += formScript;
            }
            
            return {
                id: page.id,
                name: page.get('name') || stage?.name || 'Unnamed Page',
                type: stage?.type || 'custom-page',
                html: finalHTML,
                css: pageCSS,
                js: page.get('script') || '',
                assets: [],
                basicInfo: page.get('basicInfo') || {},
                redirectPage: page.get('redirectPage') || selectedRedirectPage || '',
                isEnabled: stage?.isEnabled !== false,
                order: stages.findIndex(s => s.id === page.id)
            };
        };

        try {
            let pagesData;
            if (saveType === 'single') {
                const currentPage = editor.Pages.getSelected();
                if (!currentPage) {
                    alert("No page is selected to save.");
                    return;
                }
                pagesData = [preparePageData(currentPage)];
            } else {
                pagesData = editor.Pages.getAll().map(preparePageData);
            }

            dispatch(updateProjectData({
                pages: pagesData,
                globalCss: globalCss
            }));

            const response = await dispatch(saveFunnelToBackend({ 
                slug, 
                funnelName 
            }));

            if (saveFunnelToBackend.fulfilled.match(response)) {
                alert(saveType === 'single' ? "Page saved successfully!" : "All pages saved successfully!");
            } else {
                throw new Error(response.error?.message || 'Failed to save');
            }
        } catch (error) {
            console.error('Save error:', error);
            alert(`Failed to save data: ${error.message}`);
        }
    };

    const handleDownloadProject = () => {
        if (!editorInstance) { alert("Editor is not ready."); return; }
        const editor = editorInstance;
        const currentPage = editor.Pages.getSelected();
        if (!currentPage) { alert("No page is selected to download."); return; }
        const pageName = currentPage.get('name') || `page-${currentPage.cid}`;
        
        const pageCSS = extractPageCSS(editor, currentPage.id);
        const globalCSS = editor.getCss();
        const combinedCSS = globalCSS + '\n' + pageCSS;
        
        const fullCode = `<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>${pageName}</title><style>${combinedCSS}</style></head><body>${currentPage.getMainComponent().toHTML()}<script>${currentPage.get('script') || ''}</script></body></html>`;
        const blob = new Blob([fullCode], { type: 'text/html' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `${pageName.toLowerCase().replace(/\s+/g, '-')}.html`;
        a.click();
        URL.revokeObjectURL(a.href);
    };

    const handleAISubmit = async ({ description }) => {
        if (!editorInstance) { alert("Editor not available."); return; }
        const page = editorInstance.Pages.getSelected();
        if (!page) { alert("Please select a page first."); return; }

        setIsAILoading(true);
        const contentToUpdate = extractContentForAI(editorInstance);
        if (contentToUpdate.length === 0) {
            alert("No text or image content found on this page to update.");
            setIsAILoading(false);
            return;
        }

        const requestBody = { description, contentToUpdate, pageInfo: { id: page.id, name: page.get('name') } };

        try {
            const response = await fetch(`${API_BASE_URL}/api/ai/generate-content`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                throw new Error(`Server responded with status: ${response.status}`);
            }

            const aiResponse = await response.json();
            applyAIUpdates(editorInstance, aiResponse.updatedContent);
            alert("Content updated successfully by AI!");

        } catch (error) {
            console.error('AI Generation Error:', error);
            alert(`Failed to update content: ${error.message}`);
        } finally {
            setIsAILoading(false);
            setShowAIPopup(false);
        }
    };

    const handleTemplateSelect = (templateKey) => {
        if (!currentStage || !editorInstance) return;
        const templateSet = {
            'welcome-page': templates.welcomeTemplates, 'vsl-page': templates.vslTemplates,
            'thankyou-page': templates.thankyouTemplates, 'whatsapp-page': templates.whatsappTemplates,
            'product-offer': templates.productOfferTemplates, 'custom-page': templates.miscTemplates,
            'appointment-page': templates.appointmentTemplates, 'payment-page': templates.paymentTemplates,
        }[currentStage.type];
        const template = templateSet?.[templateKey];
        if (!template) { console.error('Template not found:', templateKey); return; }
        dispatch(setSelectedTemplateForStage({ stageId: currentStage.id, templateKey, stageType: currentStage.type }));
        const page = editorInstance.Pages.get(currentStage.id);
        if (page) {
            applyDataToPage(page, { 
                html: template.html, 
                css: template.css, 
                js: template.js, 
                basicInfo: template.basicInfo || {},
                redirectPage: template.redirectPage || ''
            });
        }
        setShowTemplateSelector(false);
    };

    const handleRedirectSelect = (pageSlug) => {
        const formattedSlug = pageSlug.replace(/^\/|\/$/g, '');
        console.log('Setting redirect page to:', formattedSlug);
        
        setSelectedRedirectPage(formattedSlug);
        
        if (editorInstance) {
            const currentPage = editorInstance.Pages.getSelected();
            if (currentPage) {
                currentPage.set('redirectPage', formattedSlug);
                console.log('Updated current page redirect to:', formattedSlug);
            }
            
            updateDirectFormsRedirect(editorInstance, formattedSlug);
            
            setTimeout(() => {
                updateDirectFormsRedirect(editorInstance, formattedSlug);
            }, 500);
            
            if (currentStage) {
                const updateData = {
                    stageId: currentStage.id,
                    stageType: currentStage.type,
                    basicInfo: currentStage.basicInfo || {},
                    redirectPage: formattedSlug
                };
                
                dispatch(updateStageBasicInfo(updateData));
                console.log('Dispatched redirect page update to Redux:', updateData);
            }
        }
        
        alert(`Redirect page set to: ${formattedSlug}\nAll direct forms will now redirect to this page after submission.`);
    };

    const openTemplateSelector = (stage) => { setCurrentStage(stage); setShowTemplateSelector(true); };
    const getSelectedTemplateKey = () => {
        if (!currentStage) return null;
        const config = currentStage.type === 'custom-page'
            ? contentData.customStagesConfig?.[currentStage.id]
            : contentData.stagesConfig?.[currentStage.type];
        return config?.selectedTemplateKey;
    };
    const forceTemplateRefresh = () => {
        if (window.confirm("Are you sure? This will reload all pages from their initial templates and discard unsaved changes.")) {
            setForceRefreshKey(prev => prev + 1);
        }
    };

    const handleBack = () => {
        if (window.confirm('Really want to exit? Unsaved changes may be lost.')) {
            dispatch(resetState());
            navigate(`/dashboard/Funnel_settings/${slug}`);
        }
    };

    const editorKey = `funnel-editor-${slug}-${forceRefreshKey}`;

    if (apiStatus === 'loading') {
        return (
            <div className="portfolio-edit-container" style={{ display: 'flex', justifyContent: 'center', alignItems: 'center', height: '100vh' }}>
                <h2>Loading Funnel Editor...</h2>
            </div>
        );
    }

    if (apiStatus === 'failed') {
        return (
            <div className="portfolio-edit-container" style={{ display: 'flex', justifyContent: 'center', alignItems: 'center', height: '100vh' }}>
                <h2>Error loading funnel. Please try again.</h2>
            </div>
        );
    }

    return (
        <div className="portfolio-edit-container">
            {showTemplateSelector && currentStage && (
                <div className="modal-overlay">
                    <div className="modal-content">
                        <button className="modal-close-btn" onClick={() => setShowTemplateSelector(false)}>Ã—</button>
                        <StageTemplateSelector
                            stageType={currentStage.type}
                            selectedKey={getSelectedTemplateKey()}
                            onSelect={handleTemplateSelect}
                        />
                    </div>
                </div>
            )}

            {showAIPopup && (
                <div className="modal-overlay">
                    <div className="modal-content ai-modal-content">
                        <AIGenerativePopup
                            isLoading={isAILoading}
                            onClose={() => setShowAIPopup(false)}
                            onSubmit={handleAISubmit}
                        />
                    </div>
                </div>
            )}

            {showRedirectPopup && (
                <div className="modal-overlay">
                    <div className="modal-content">
                        <button className="modal-close-btn" onClick={() => setShowRedirectPopup(false)}>Ã—</button>
                        <RedirectPageSelector
                            stages={stages}
                            currentStageId={stageId}
                            onSelect={handleRedirectSelect}
                            onClose={() => setShowRedirectPopup(false)}
                        />
                    </div>
                </div>
            )}

            <div className="action-buttons">
                <button onClick={() => handleSave('single')} className="action-button save-button">
                    <FaSave /> <span>Save Page</span>
                </button>
                <button onClick={() => handleSave('all')} className="action-button save-all-button">
                    <FaFileExport /> <span>Save All</span>
                </button>
                <button onClick={() => setShowAIPopup(true)} className="action-button ai-generate-button">
                    <FaMagic /> <span>AI Content</span>
                </button>
                <button onClick={() => setShowRedirectPopup(true)} className="action-button redirect-button">
                    <FaFileAlt /> <span>Set Redirect</span>
                </button>
                <button onClick={forceTemplateRefresh} className="action-button refresh-button">
                    <FaSync /> <span>Refresh</span>
                </button>
                <button onClick={handleDownloadProject} className="action-button download-button">
                    <FaDownload /> <span>Download</span>
                </button>
                <button onClick={handleBack} className="action-button back-button">
                    <FaArrowLeft /> <span>Back</span>
                </button>
            </div>

            <div className="editor-main-area" style={{ width: '100%', height: '100%' }}>
                <div id="pages" className="pages-container" />
                <StudioEditor
                    key={editorKey}
                    onEditor={onEditorReady}
                    style={{ width: "100%", height: "100%" }}
                    options={{
                        storage: {
                            type: "self",
                            onSave: async ({ project }) => console.log("[Frontend] Project auto-synced (GrapesJS internal).", project),
                            onLoad: () => ({ project: generateInitialProject() }),
                        },
                        assetManager: {
                            assets: assets.map(asset => ({
                                ...asset,
                                src: asset.src.startsWith('/') ? asset.src : `/${asset.src}`
                            })),
                            upload: `${API_BASE_URL}/api/assets`,
                            uploadName: 'assets',
                            multiUpload: true,
                            customUpload: async (files, onComplete, onError) => {
                                try {
                                    const uploaded = await uploadFiles(files);
                                    onComplete(uploaded.map(asset => ({
                                        ...asset,
                                        src: asset.src.startsWith('/') ? asset.src : `/${asset.src}`
                                    })));
                                    setAssets(prev => [...uploaded, ...prev]);
                                } catch (err) {
                                    console.error(err);
                                    onError(err.message);
                                }
                            },
                        },
                        plugins: [
                            gjsForms, gjsCountdown, gjsTabs, gjsCustomCode,
                            gjsTooltip, gjsTyped, gjsNavbar, gjsBlocksBasic,
                        ],
                    }}
                />
            </div>

            <style jsx>{`
                /* --- Main Layout --- */
                .portfolio-edit-container {
                    display: flex;
                    height: 100vh; 
                    width: 100vw;
                    position: relative; 
                    overflow: hidden;
                    font-family: 'Segoe UI', Tahoma, sans-serif;
                    background-color: #f0f2f5;
                }
                .editor-main-area {
                    flex-grow: 1;
                    position: relative;
                    height: 100%;
                }
                .pages-container {
                    position: absolute; 
                    top: 15px; 
                    left: 15px;
                    z-index: 1000; 
                    background: rgba(30, 30, 30, 0.9);
                    color: white;
                    padding: 8px; 
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
                }

                /* --- Action Buttons --- */
                .action-buttons {
                    position: fixed; 
                    bottom: 20px; 
                    right: 20px;
                    z-index: 1001; 
                    display: flex;
                    flex-direction: column; 
                    gap: 12px;
                }
                .action-button {
                    padding: 12px 18px; 
                    border: none; 
                    border-radius: 8px;
                    font-weight: 600; 
                    cursor: pointer;
                    transition: all 0.2s ease;
                    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
                    display: flex; 
                    align-items: center; 
                    gap: 10px; 
                    font-size: 14px;
                }
                .action-button:hover {
                    transform: translateY(-3px);
                    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
                }
                .action-button > svg { 
                    font-size: 1.1rem; 
                }
                .save-button { background-color: #3498db; color: white; }
                .save-all-button { background-color: #16a085; color: white; }
                .ai-generate-button { background-color: #8e44ad; color: white; }
                .redirect-button { background-color: #2ecc71; color: white; }
                .refresh-button { background-color: #f39c12; color: white; }
                .download-button { background-color: #27ae60; color: white; }
                .back-button { background-color: #c0392b; color: white; }

                /* --- Modal Styles --- */
                .modal-overlay {
                    position: fixed; top: 0; left: 0;
                    width: 100%; height: 100%;
                    background-color: rgba(0, 0, 0, 0.6);
                    display: flex; justify-content: center; align-items: center;
                    z-index: 2000;
                }
                .modal-content {
                    background: white; padding: 25px; border-radius: 10px;
                    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
                    max-width: 90vw; max-height: 90vh;
                    overflow-y: auto; position: relative;
                }
                .modal-close-btn {
                    position: absolute; top: 10px; right: 15px;
                    background: transparent; border: none;
                    font-size: 24px; cursor: pointer; color: #888;
                }
                .cancel{
                    background-color: #4a5568 !important;
                    color: #e0e6ed;
                    border: 1px solid #5a6b7d;
                    padding: 12px 25px;
                    border-radius: 10px;
                    font-size: 15px;
                    font-weight: 700;
                    cursor: pointer;
                    transition: all 0.3s ease-in-out, transform 0.2s ease-out;
                    letter-spacing: 0.3px;
                    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
                }
                .ai-modal-content { max-width: 550px; }

                /* --- Redirect Popup Styles --- */
                .redirect-popup-content {
                    min-width: 400px;
                    max-width: 500px;
                }
                .redirect-popup-content h3 {
                    margin-top: 0;
                    color: #2c3e50;
                }
                .redirect-popup-content p {
                    color: #7f8c8d;
                    margin-bottom: 20px;
                }
                .redirect-popup-content select {
                    width: 100%;
                    padding: 10px;
                    border: 1px solid #ddd;
                    border-radius: 4px;
                    font-size: 14px;
                }
                .popup-buttons {
                    display: flex;
                    justify-content: flex-end;
                    gap: 10px;
                    margin-top: 20px;
                }
                .popup-buttons button {
                    padding: 8px 16px;
                    border-radius: 4px;
                    cursor: pointer;
                }
                .cancel-btn {
                    background-color: #e74c3c;
                    color: white;
                    border: none;
                }
                .submit-btn {
                    background-color: #2ecc71;
                    color: white;
                    border: none;
                }

                /* --- AI Popup Specific Styles --- */
                .ai-popup-content h3 { margin-top: 0; color: #333; }
                .ai-popup-content p { color: #555; margin-bottom: 20px; }
                .description-section { margin-top: 15px; }
                .description-section label { display: block;color:black; margin-bottom: 8px; font-weight: 500; }
                .description-section textarea { width: 100%; color:black; padding: 10px; border-radius: 5px; border: 1px solid #ccc; resize: vertical; box-sizing: border-box; }
                .ai-popup-buttons { display: flex; justify-content: flex-end; gap: 10px; margin-top: 25px; }
                .ai-popup-buttons button { padding: 10px 20px; border-radius: 5px; border: none; font-weight: 500; cursor: pointer; }
                .ai-cancel-btn { background-color: #eee; }
                .ai-submit-btn { background-color: #4f46e5; color: white; }
                .ai-submit-btn:disabled { background-color: #ccc; cursor: not-allowed; }

                /* --- Template Selector Styles --- */
                .template-selector-container { width: 90vw; max-width: 1200px; }
                .template-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; }
                .template-card { border: 2px solid transparent; border-radius: 8px; overflow: hidden; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
                .template-card:hover { transform: translateY(-5px); box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
                .template-card.selected { border-color: #3498db; box-shadow: 0 0 10px rgba(52, 152, 219, 0.5); }
                .template-thumbnail img { width: 100%; height: auto; display: block; background-color: #eee; }
                .template-info { padding: 15px; }
                .template-info h4 { margin: 0 0 8px 0; font-size: 16px; }
                .template-info p { margin: 0; font-size: 14px; color: #666; }
                .main-content.fixed-sidebar { margin-left:0px; }
            `}</style>
        </div>
    );
};

export default PortfolioEdit;